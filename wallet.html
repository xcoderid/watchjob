<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dompet - WatchJob</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#1e293b', gold: '#f59e0b' }, fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>[x-cloak]{display:none} .nav-item.active{color:#1e293b;}</style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col max-w-lg mx-auto shadow-2xl bg-white" x-data="walletApp()" x-init="init()">

    <header class="h-16 bg-white border-b flex items-center px-6 shrink-0 z-20">
        <h1 class="font-bold text-lg text-slate-800">Dompet</h1>
    </header>

    <main class="flex-1 overflow-y-auto p-5 pb-28 space-y-6">
        
        <!-- BALANCE CARD (BARU) -->
        <div class="bg-primary rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Saldo Tersedia</p>
                <h2 class="text-3xl font-bold text-white" x-text="fmtMoney(user?.balance || 0)"></h2>
            </div>
            <div class="absolute -bottom-4 -right-4 text-8xl text-white/5"><i class="fa-solid fa-wallet"></i></div>
        </div>

        <!-- Tabs -->
        <div class="bg-slate-100 p-1 rounded-xl flex">
            <button @click="tab='depo'" :class="tab==='depo'?'bg-white text-slate-800 shadow':'text-slate-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition">DEPOSIT</button>
            <button @click="tab='wd'" :class="tab==='wd'?'bg-white text-slate-800 shadow':'text-slate-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition">WITHDRAW</button>
        </div>

        <!-- Deposit Form -->
        <div x-show="tab==='depo'" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Isi Saldo</h3>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400">Jumlah</label><input x-model="depo.amount" type="number" class="w-full p-3 border rounded-xl mt-1 font-bold" placeholder="10000"></div>
                <div><label class="text-xs font-bold text-slate-400">Metode</label><select x-model="depo.method" class="w-full p-3 border rounded-xl mt-1 bg-white"><option>Bank Transfer</option><option>E-Wallet</option><option>QRIS</option></select></div>
                <button @click="submitDepo" :disabled="loading" class="w-full py-3 bg-primary text-white font-bold rounded-xl shadow-lg">Konfirmasi</button>
            </div>
        </div>

        <!-- Withdraw Form -->
        <div x-show="tab==='wd'" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Tarik Saldo</h3>
            <div class="p-3 bg-blue-50 text-blue-700 text-xs rounded-lg mb-4 border border-blue-100">Pastikan data bank sudah diisi di menu Profil.</div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400">Jumlah (Min 50.000)</label><input x-model="wd.amount" type="number" class="w-full p-3 border rounded-xl mt-1 font-bold" placeholder="50000"></div>
                <button @click="submitWd" :disabled="loading" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg">Tarik Uang</button>
            </div>
        </div>

    </main>

    <nav class="bg-white border-t flex justify-around items-center h-20 shrink-0 z-40 pb-4 text-slate-400">
        <a href="dashboard.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Beranda</span></a>
        <a href="jobs.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-play-circle text-xl"></i><span class="text-[10px] font-bold">Misi</span></a>
        <a href="plans.html" class="relative -top-6 bg-primary text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center border-4 border-slate-50"><i class="fa-solid fa-gem text-2xl"></i></a>
        <a href="wallet.html" class="flex flex-col items-center w-16 gap-1 nav-item active"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold">Dompet</span></a>
        <a href="profile.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Profil</span></a>
    </nav>

    <script>
        function walletApp() {
            return {
                tab: 'depo',
                user: JSON.parse(localStorage.getItem('user') || '{}'),
                depo: { amount: '', method: 'Bank Transfer' },
                wd: { amount: '' },
                loading: false,
                
                async init() {
                    if(!localStorage.getItem('token')) return window.location.href = 'index.html';
                    const urlParams = new URLSearchParams(window.location.search);
                    if(urlParams.get('tab')) this.tab = urlParams.get('tab');
                    
                    // Fetch latest balance
                    await this.fetchUser();
                },

                async fetchUser() {
                    try {
                        const res = await fetch(`/api/users?id=${this.user.id}`, { 
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } 
                        });
                        if(res.ok) {
                            const data = await res.json();
                            this.user = data.user;
                            localStorage.setItem('user', JSON.stringify(this.user)); // Update cache
                        }
                    } catch(e) {}
                },

                async api(body) {
                    const res = await fetch('/api/transactions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: JSON.stringify(body)
                    });
                    const json = await res.json();
                    if(!res.ok) throw new Error(json.error);
                    return json;
                },

                async submitDepo() {
                    if(this.depo.amount < 10000) return alert('Minimal 10.000');
                    this.loading = true;
                    try {
                        await this.api({ type: 'deposit', ...this.depo });
                        alert('Deposit diajukan!');
                        window.location.href = 'history.html';
                    } catch(e){ alert(e.message); } finally { this.loading = false; }
                },

                async submitWd() {
                    if(this.wd.amount < 50000) return alert('Minimal 50.000');
                    this.loading = true;
                    try {
                        await this.api({ type: 'withdrawal', amount: this.wd.amount });
                        alert('Penarikan diproses!');
                        window.location.href = 'history.html';
                    } catch(e){ alert(e.message); } finally { this.loading = false; }
                },

                fmtMoney(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0); }
            }
        }
    </script>
</body>
</html>
