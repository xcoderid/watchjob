<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AdView Pro Mobile</title>
    
    <!-- 1. Tailwind CSS (CDN untuk Development) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 3. LOGIKA APLIKASI (Wajib Didefinisikan Sebelum Alpine) -->
    <script>
        // Konfigurasi Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#1e293b',
                        accent: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }

        // Fungsi Utama Data Alpine.js
        function appData() {
            return {
                // --- STATE VARIABLES ---
                authView: 'login',
                view: 'home',
                loading: false,
                user: null,
                token: null,
                plan: null,
                
                // Data Arrays
                jobs: [],
                plansList: [],
                history: [],
                completedJobIds: [],
                
                // Admin Data
                adminUsers: [],
                adminPlans: [],
                adminJobs: [],
                adminStats: {},
                
                // Form Models
                forms: {
                    login: { username: '', password: '' },
                    register: { username: '', email: '', password: '', referral_code: '' },
                    transaction: { amount: '', method: 'Transfer Bank', account_info: '' },
                    plan: { name: '', price: '', duration: '', daily_jobs: '', daily_income: '', return_capital: false, video_seconds: 30, thumbnail: '' },
                    job: { title: '', url: '', reward: '', min_level: 1 }
                },

                // UI States
                walletAction: null,
                showPlanModal: false,
                showJobModal: false,
                toast: { show: false, message: '', type: 'success' },

                // Player States
                activeJob: null,
                activeJobDuration: 0,
                jobTimer: 0,
                timerInterval: null,
                isPageVisible: true,

                // --- INIT ---
                initApp() {
                    console.log('App Initializing...');
                    
                    // Cek Session Tersimpan
                    const savedToken = localStorage.getItem('adview_token');
                    const savedUser = localStorage.getItem('adview_user');

                    if (savedToken && savedUser) {
                        this.token = savedToken;
                        this.user = JSON.parse(savedUser);
                        
                        // Route berdasarkan Role
                        if (this.user.role === 'admin') {
                            this.view = 'admin_dash';
                            this.fetchAdminStats();
                        } else {
                            this.view = 'home';
                            this.fetchData();
                        }
                    }

                    // Anti-Cheat Listener
                    document.addEventListener("visibilitychange", () => {
                        this.isPageVisible = !document.hidden;
                        if (this.view === 'do_job' && this.timerInterval) {
                            if (!this.isPageVisible) {
                                clearInterval(this.timerInterval);
                                this.timerInterval = null;
                            } else {
                                if (!this.timerInterval && this.jobTimer > 0) this.startTimer();
                            }
                        }
                    });
                },

                // --- API HANDLER (FIXED) ---
                async api(endpoint, method = 'GET', body = null) {
                    const headers = { 'Content-Type': 'application/json' };
                    if (this.token) headers['Authorization'] = `Bearer ${this.token}`;

                    try {
                        const res = await fetch(endpoint, {
                            method,
                            headers,
                            body: body ? JSON.stringify(body) : null
                        });
                        
                        const json = await res.json();
                        
                        if (!res.ok) {
                            // Lempar error dengan pesan dari backend jika ada
                            throw new Error(json.error || `Error ${res.status}: ${res.statusText}`);
                        }
                        
                        return json;
                    } catch (e) {
                        console.error("API Error:", e);
                        this.showToast(e.message, 'error');
                        throw e; // Re-throw agar caller tau ini gagal
                    }
                },

                // --- AUTHENTICATION ---
                async login() {
                    this.loading = true;
                    try {
                        const res = await this.api('/api/auth?type=login', 'POST', this.forms.login);
                        if (res.success) {
                            this.token = res.token;
                            this.user = res.user;
                            this.plan = res.plan;
                            
                            localStorage.setItem('adview_token', res.token);
                            localStorage.setItem('adview_user', JSON.stringify(res.user));
                            
                            this.view = res.user.role === 'admin' ? 'admin_dash' : 'home';
                            if(this.user.role === 'member') this.fetchData();
                            else this.fetchAdminStats();
                            
                            this.showToast('Login berhasil!', 'success');
                        }
                    } catch (e) {
                        // Error sudah ditangani di api() via showToast
                    } finally { this.loading = false; }
                },

                async register() {
                    this.loading = true;
                    try {
                        const res = await this.api('/api/auth?type=register', 'POST', this.forms.register);
                        if (res.success) {
                            this.showToast('Registrasi berhasil! Silakan login.', 'success');
                            this.authView = 'login';
                            this.forms.register = { username: '', email: '', password: '', referral_code: '' };
                        }
                    } catch (e) {
                        // Error sudah ditangani di api()
                    } finally { this.loading = false; }
                },

                logout() {
                    this.token = null;
                    this.user = null;
                    this.plan = null;
                    localStorage.removeItem('adview_token');
                    localStorage.removeItem('adview_user');
                    this.view = 'home';
                    this.showToast('Berhasil keluar.', 'success');
                },

                // --- DATA FETCHING ---
                async fetchData() {
                    if (!this.user || this.user.role !== 'member') return;
                    try {
                        // Parallel fetch agar lebih cepat
                        const [userData, plansData, jobsData, trxData] = await Promise.all([
                            this.api(`/api/users?id=${this.user.id}`),
                            this.api('/api/plans'),
                            this.api(`/api/jobs?user_id=${this.user.id}`),
                            this.api(`/api/transactions?user_id=${this.user.id}`)
                        ]);

                        this.user = { ...this.user, ...userData.user };
                        this.plan = userData.plan;
                        this.plansList = plansData;
                        this.jobs = jobsData.jobs;
                        this.completedJobIds = jobsData.completed_ids;
                        this.history = trxData;
                        
                        // Update local storage user data agar balance sync
                        localStorage.setItem('adview_user', JSON.stringify(this.user));
                        
                    } catch (e) { console.error("Fetch Data Error", e); }
                },

                // --- ADMIN DATA ---
                async fetchAdminStats() { try { this.adminStats = await this.api('/api/admin?type=stats'); } catch(e){} },
                async fetchAdminUsers() { try { this.adminUsers = await this.api('/api/admin?type=users'); } catch(e){} },
                async fetchAdminPlans() { try { this.adminPlans = await this.api('/api/admin?type=plans'); } catch(e){} },
                async fetchAdminJobs() { try { const res = await this.api(`/api/jobs?user_id=${this.user.id}`); this.adminJobs = res.jobs; } catch(e){} },

                // --- ADMIN ACTIONS ---
                async toggleUserStatus(userId, currentStatus) {
                    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                    if(!confirm(`Ubah status user ke ${newStatus}?`)) return;
                    try {
                        await this.api('/api/admin', 'POST', { action: 'toggle_user', user_id: userId, status: newStatus });
                        this.fetchAdminUsers();
                        this.showToast('Status user diubah', 'success');
                    } catch(e){}
                },
                async createPlan() {
                    try {
                        await this.api('/api/admin', 'POST', { 
                            action: 'create_plan', 
                            name: this.forms.plan.name,
                            price: parseFloat(this.forms.plan.price),
                            duration: parseInt(this.forms.plan.duration),
                            daily_jobs: parseInt(this.forms.plan.daily_jobs),
                            daily_income: parseFloat(this.forms.plan.daily_income),
                            return_capital: this.forms.plan.return_capital ? 1 : 0,
                            video_seconds: parseInt(this.forms.plan.video_seconds),
                            thumbnail: this.forms.plan.thumbnail
                        });
                        this.showPlanModal = false;
                        this.fetchAdminPlans();
                        this.showToast('Plan dibuat', 'success');
                    } catch(e){}
                },
                async createJob() {
                    try {
                        await this.api('/api/admin', 'POST', {
                            action: 'create_job',
                            title: this.forms.job.title,
                            url: this.forms.job.url,
                            reward: parseFloat(this.forms.job.reward),
                            min_level: parseInt(this.forms.job.min_level)
                        });
                        this.showJobModal = false;
                        this.fetchAdminJobs();
                        this.showToast('Job ditambahkan', 'success');
                    } catch(e){}
                },

                // --- JOB SYSTEM ---
                startJob(job) {
                    const duration = this.plan ? this.plan.video_duration_sec : 15;
                    this.activeJob = job;
                    this.activeJobDuration = duration;
                    this.jobTimer = duration;
                    this.view = 'do_job';
                    this.isPageVisible = true;
                    this.startTimer();
                },
                startTimer() {
                    if(this.timerInterval) clearInterval(this.timerInterval);
                    this.timerInterval = setInterval(() => {
                        if(this.isPageVisible && this.jobTimer > 0) {
                            this.jobTimer--;
                        }
                        if(this.jobTimer <= 0) {
                            clearInterval(this.timerInterval);
                            this.timerInterval = null;
                        }
                    }, 1000);
                },
                cancelJob() {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                    this.activeJob = null;
                    this.view = 'jobs';
                },
                async claimJob() {
                    if(this.jobTimer > 0) return;
                    try {
                        const res = await this.api('/api/jobs', 'POST', { action: 'claim', user_id: this.user.id, job_id: this.activeJob.id });
                        this.showToast(`Reward +${this.formatRupiah(res.reward)}`, 'success');
                        this.cancelJob();
                        this.fetchData();
                    } catch(e){}
                },
                isJobDone(id) { return this.completedJobIds.includes(id); },

                // --- TRANSACTION SYSTEM ---
                async buyPlan(plan) {
                    if(!confirm(`Beli ${plan.name}?`)) return;
                    try {
                        await this.api('/api/plans', 'POST', { user_id: this.user.id, plan_id: plan.id });
                        this.showToast('Upgrade sukses!', 'success');
                        this.fetchData();
                    } catch(e){}
                },
                async handleTransaction() {
                    try {
                        const res = await this.api('/api/transactions', 'POST', {
                            user_id: this.user.id,
                            type: this.walletAction === 'deposit' ? 'deposit' : 'withdrawal',
                            amount: parseFloat(this.forms.transaction.amount),
                            method: this.forms.transaction.method,
                            account_info: this.forms.transaction.account_info
                        });
                        this.showToast(res.message, 'success');
                        this.walletAction = null;
                        this.fetchData();
                    } catch(e){}
                },

                // --- HELPERS ---
                async changeView(v) {
                    this.view = v;
                    if(this.user) {
                        if(this.user.role === 'member') this.fetchData();
                        else {
                             if(v==='admin_dash') this.fetchAdminStats();
                             if(v==='admin_users') this.fetchAdminUsers();
                             if(v==='admin_plans') this.fetchAdminPlans();
                             if(v==='admin_jobs') this.fetchAdminJobs();
                        }
                    }
                },
                formatRupiah(num) { return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", maximumFractionDigits: 0 }).format(num || 0); },
                formatTime(sec) { const m = Math.floor(sec/60).toString().padStart(2,'0'); const s = (sec%60).toString().padStart(2,'0'); return `${m}:${s}`; },
                getYoutubeId(url) {
                    if(!url) return '';
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = url.match(regExp);
                    return (match && match[2].length === 11) ? match[2] : 'dQw4w9WgXcQ';
                },
                showToast(msg, type='success') {
                    this.toast.message = msg;
                    this.toast.type = type;
                    this.toast.show = true;
                    setTimeout(() => this.toast.show = false, 4000);
                },
                copyRef() {
                    navigator.clipboard.writeText(this.user.referral_code);
                    this.showToast('Kode disalin', 'success');
                }
            }
        }
    </script>
    
    <!-- 4. Alpine.js (LOAD TERAKHIR dengan DEFER) -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #f1f5f9; }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .marquee-container { overflow: hidden; white-space: nowrap; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="text-slate-800 antialiased font-sans" x-data="appData()" x-init="initApp()">

    <!-- === TOAST NOTIFICATION === -->
    <div class="fixed top-4 left-0 right-0 flex justify-center z-[99] pointer-events-none">
        <div class="w-full max-w-[480px] px-4 flex justify-center">
            <div x-show="toast.show" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform -translate-y-4"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-4"
                 class="bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 pointer-events-auto border border-slate-700 backdrop-blur-md bg-opacity-95">
                <i class="fa-solid" :class="toast.type === 'error' ? 'fa-circle-exclamation text-red-400' : 'fa-circle-check text-green-400'"></i>
                <span class="text-sm font-medium" x-text="toast.message"></span>
            </div>
        </div>
    </div>

    <div class="app-container">
        
        <!-- ==================== 1. AUTH PAGE ==================== -->
        <template x-if="!token">
            <div class="flex-1 flex flex-col bg-white p-6 justify-center animate-fade-in relative overflow-hidden">
                <div class="absolute top-[-50px] right-[-50px] w-40 h-40 bg-indigo-50 rounded-full blur-3xl opacity-60"></div>
                <div class="absolute bottom-[-50px] left-[-50px] w-40 h-40 bg-blue-50 rounded-full blur-3xl opacity-60"></div>

                <div class="text-center mb-8 relative z-10">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl mb-5 text-white text-4xl shadow-lg shadow-indigo-200">
                        <i class="fa-brands fa-youtube"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-900 tracking-tight">AdView Pro</h1>
                    <p class="text-slate-500 text-sm mt-2 font-medium">Platform Penghasil Cuan No. #1</p>
                </div>

                <!-- Tabs -->
                <div class="bg-slate-50 p-1.5 rounded-xl flex mb-6 border border-slate-100 relative z-10">
                    <button @click="authView='login'" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-200" :class="authView==='login' ? 'bg-white shadow-sm text-primary ring-1 ring-black/5' : 'text-slate-400 hover:text-slate-600'">Masuk</button>
                    <button @click="authView='register'" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-200" :class="authView==='register' ? 'bg-white shadow-sm text-primary ring-1 ring-black/5' : 'text-slate-400 hover:text-slate-600'">Daftar</button>
                </div>

                <!-- LOGIN -->
                <form x-show="authView==='login'" @submit.prevent="login" class="space-y-4 relative z-10 animate-slide-up">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Username</label>
                        <input type="text" x-model="forms.login.username" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary outline-none" placeholder="Username" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Password</label>
                        <input type="password" x-model="forms.login.password" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary outline-none" placeholder="Password" required>
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition disabled:opacity-70" :disabled="loading">
                        <span x-show="!loading">Masuk Sekarang</span>
                        <span x-show="loading"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Memproses...</span>
                    </button>
                </form>

                <!-- REGISTER -->
                <form x-show="authView==='register'" @submit.prevent="register" class="space-y-4 relative z-10 animate-slide-up">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Username</label>
                        <input type="text" x-model="forms.register.username" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Email</label>
                        <input type="email" x-model="forms.register.email" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Password</label>
                        <input type="password" x-model="forms.register.password" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Kode Referral</label>
                        <input type="text" x-model="forms.register.referral_code" class="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="Opsional">
                    </div>
                    <button type="submit" class="w-full bg-secondary hover:bg-slate-700 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition disabled:opacity-70" :disabled="loading">
                        <span x-show="!loading">Daftar Akun Baru</span>
                        <span x-show="loading"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Mendaftar...</span>
                    </button>
                </form>
            </div>
        </template>

        <!-- ==================== 2. MAIN APP ==================== -->
        <template x-if="token && user">
            <div class="flex flex-col h-screen overflow-hidden bg-slate-50">
                
                <!-- HEADER -->
                <header class="bg-white px-5 py-4 shadow-sm flex justify-between items-center z-30 sticky top-0" x-show="view !== 'do_job' && !view.startsWith('admin')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-primary font-bold text-sm border border-indigo-100">
                            <span x-text="user.username.substring(0,2).toUpperCase()"></span>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Saldo Dompet</p>
                            <p class="font-bold text-slate-800 text-sm" x-text="formatRupiah(user.balance)"></p>
                        </div>
                    </div>
                    <span class="text-[10px] font-bold bg-gradient-to-r from-accent to-orange-500 text-white px-3 py-1 rounded-full shadow-sm" x-text="plan ? plan.name : 'Free Trial'"></span>
                </header>

                <!-- ADMIN HEADER -->
                <header x-show="user.role === 'admin' && view.startsWith('admin')" class="bg-secondary text-white px-5 py-4 shadow-lg sticky top-0 z-30 flex items-center justify-between">
                    <h1 class="text-xl font-bold">Admin Panel</h1>
                    <button @click="logout" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-right-from-bracket"></i></button>
                </header>

                <!-- CONTENT -->
                <main class="flex-1 overflow-y-auto no-scrollbar pb-24 relative scroll-smooth">
                    
                    <!-- MEMBER: HOME -->
                    <div x-show="user.role === 'member' && view === 'home'" class="p-4 space-y-5 animate-fade-in">
                        <div class="bg-white border border-slate-100 rounded-lg p-2.5 shadow-sm flex items-center">
                            <i class="fa-solid fa-volume-high text-accent mr-3 text-sm"></i>
                            <div class="marquee-container flex-1 text-xs text-slate-600 font-medium">
                                <div class="marquee-content">Halo <span x-text="user.username"></span>! Selesaikan misi harian untuk cuan maksimal.</div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-indigo-600 to-violet-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-indigo-100 text-xs font-medium mb-1">Pendapatan Hari Ini</p>
                                <h2 class="text-3xl font-bold mb-6" x-text="formatRupiah(user.today_income)"></h2>
                                <div class="flex gap-3">
                                    <button @click="changeView('jobs')" class="bg-white text-primary px-5 py-2.5 rounded-xl text-xs font-bold shadow-lg active:scale-95 transition">Misi</button>
                                    <button @click="changeView('plans')" class="bg-white/20 backdrop-blur text-white px-5 py-2.5 rounded-xl text-xs font-bold active:scale-95 transition">Upgrade</button>
                                </div>
                            </div>
                            <i class="fa-brands fa-youtube absolute -bottom-4 -right-4 text-[8rem] text-white opacity-10 rotate-12"></i>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-24 justify-center">
                                <p class="text-xs text-slate-500 font-bold mb-1">Tugas Selesai</p>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-xl font-bold text-slate-800" x-text="user.tasks_done"></span>
                                    <span class="text-xs text-slate-400">/ <span x-text="plan ? plan.daily_jobs_limit : 0"></span></span>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-24 justify-center" @click="changeView('account')">
                                <p class="text-xs text-slate-500 font-bold mb-1">Referral</p>
                                <p class="text-xl font-bold text-slate-800">0 <span class="text-xs font-normal text-slate-400">Member</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- MEMBER: JOBS -->
                    <div x-show="user.role === 'member' && view === 'jobs'" class="p-4 space-y-4 animate-fade-in">
                        <div class="flex justify-between items-end mb-2">
                            <h2 class="font-bold text-lg text-slate-800">Daftar Misi</h2>
                            <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">RESET: 00:00 WIB</span>
                        </div>
                        
                        <div x-show="user.tasks_done >= (plan ? plan.daily_jobs_limit : 0)" class="bg-red-50 text-red-600 p-5 rounded-xl text-sm text-center border border-red-100">
                            <span class="font-bold block">Kuota Harian Habis</span>
                            Upgrade Plan untuk tambah kuota.
                        </div>

                        <div class="space-y-3 pb-10">
                            <template x-for="job in jobs" :key="job.id">
                                <div class="bg-white p-3 rounded-xl shadow-sm flex gap-3 items-center border border-slate-100">
                                    <div class="w-28 h-16 bg-slate-200 rounded-lg overflow-hidden relative shrink-0">
                                        <img :src="'https://img.youtube.com/vi/'+ getYoutubeId(job.youtube_url) +'/mqdefault.jpg'" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-bold text-sm text-slate-800 truncate" x-text="job.title"></h4>
                                        <span class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded mt-1 inline-block">+ <span x-text="formatRupiah(job.reward_amount)"></span></span>
                                    </div>
                                    <div class="shrink-0">
                                        <template x-if="isJobDone(job.id)">
                                            <div class="w-9 h-9 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fa-solid fa-check"></i></div>
                                        </template>
                                        <template x-if="!isJobDone(job.id)">
                                            <button @click="startJob(job)" :disabled="user.tasks_done >= (plan ? plan.daily_jobs_limit : 0)" class="bg-primary text-white text-xs font-bold px-4 py-2 rounded-lg shadow active:scale-95 disabled:opacity-50">Kerjakan</button>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- MEMBER: DO JOB -->
                    <div x-show="view === 'do_job'" class="bg-black h-full flex flex-col relative z-50" x-cloak>
                        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center text-white z-20 bg-gradient-to-b from-black/80 to-transparent">
                            <button @click="cancelJob" class="flex items-center gap-2 text-sm font-bold opacity-80"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                            <div class="bg-red-600 px-3 py-1 rounded-full text-xs font-bold shadow animate-pulse flex items-center gap-1">REC <span x-text="formatTime(jobTimer)"></span></div>
                        </div>
                        
                        <div x-show="!isPageVisible" class="absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-center text-center p-8 text-white">
                            <i class="fa-solid fa-eye-slash text-5xl mb-4 text-red-500"></i>
                            <h3 class="font-bold text-xl text-red-500">PLAYER PAUSED</h3>
                            <p class="text-sm text-gray-400">Jangan pindah tab!</p>
                        </div>

                        <div class="flex-1 flex items-center justify-center bg-slate-900 relative">
                             <div class="w-full aspect-video bg-black relative">
                                <img x-show="activeJob" :src="'https://img.youtube.com/vi/'+ getYoutubeId(activeJob?.youtube_url || '') +'/hqdefault.jpg'" class="w-full h-full object-cover opacity-50">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-white z-10">
                                    <div class="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center mb-3 animate-pulse"><i class="fa-solid fa-play text-2xl ml-1"></i></div>
                                    <p class="font-bold text-lg" x-text="jobTimer > 0 ? 'Menonton...' : 'Selesai!'"></p>
                                </div>
                             </div>
                        </div>

                        <div class="bg-slate-900 p-6 rounded-t-3xl text-white relative z-10 shadow-2xl">
                            <h3 class="font-bold text-lg mb-1 line-clamp-1" x-text="activeJob?.title"></h3>
                            <div class="w-full bg-slate-800 rounded-full h-2 mb-6 overflow-hidden">
                                <div class="bg-gradient-to-r from-primary to-purple-500 h-full rounded-full transition-all duration-1000 ease-linear" :style="`width: ${((activeJobDuration - jobTimer) / activeJobDuration) * 100}%`"></div>
                            </div>
                            <button x-show="jobTimer <= 0" @click="claimJob" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95">KLAIM REWARD <span x-text="formatRupiah(activeJob?.reward_amount)"></span></button>
                            <button x-show="jobTimer > 0" class="w-full bg-slate-800 text-slate-500 font-bold py-4 rounded-xl cursor-not-allowed">Tunggu Timer Habis...</button>
                        </div>
                    </div>

                    <!-- MEMBER: PLANS -->
                    <div x-show="user.role === 'member' && view === 'plans'" class="p-4 space-y-5 animate-fade-in">
                        <h2 class="font-bold text-xl text-slate-800 text-center">Pilih Paket VIP</h2>
                        <div class="space-y-4 pb-10">
                            <template x-for="p in plansList" :key="p.id">
                                <div class="bg-white rounded-2xl overflow-hidden shadow-sm border relative group" :class="plan && plan.name === p.name ? 'border-green-500 ring-2 ring-green-500/20' : 'border-slate-100'">
                                    <div x-show="plan && plan.name === p.name" class="absolute top-3 right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow z-10">AKTIF</div>
                                    <div class="relative h-32 bg-slate-200">
                                        <img :src="p.thumbnail_url" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400/1e293b/ffffff?text=VIP+Plan'">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex items-end p-4">
                                            <div class="text-white">
                                                <h3 class="font-bold text-xl leading-tight" x-text="p.name"></h3>
                                                <p class="text-xs text-yellow-300 font-medium mt-1"><i class="fa-solid fa-calendar mr-1"></i> <span x-text="p.duration_days"></span> Hari</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-5">
                                        <div class="flex justify-between items-end mb-4 border-b border-dashed border-slate-100 pb-4">
                                            <div><p class="text-[10px] text-slate-400 uppercase font-bold">Harga</p><p class="text-xl font-bold text-primary" x-text="formatRupiah(p.price)"></p></div>
                                            <div class="text-right"><p class="text-[10px] text-slate-400 uppercase font-bold">Estimasi/Hari</p><p class="font-bold text-green-600 text-lg" x-text="formatRupiah(p.daily_income)"></p></div>
                                        </div>
                                        <button @click="buyPlan(p)" :disabled="plan && plan.name === p.name" class="w-full py-3.5 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2 shadow-sm" :class="plan && plan.name === p.name ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-secondary text-white active:scale-95 hover:bg-slate-700'">
                                            <span x-text="plan && plan.name === p.name ? 'Paket Aktif' : 'Beli Paket'"></span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- MEMBER: WALLET -->
                    <div x-show="user.role === 'member' && view === 'wallet'" class="p-4 space-y-6 animate-fade-in">
                         <div class="bg-white p-6 rounded-2xl shadow-sm text-center border border-slate-100">
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Saldo Tersedia</p>
                            <h2 class="text-4xl font-bold text-slate-800 mb-8" x-text="formatRupiah(user.balance)"></h2>
                            <div class="grid grid-cols-2 gap-4">
                                <button @click="walletAction = 'deposit'" class="p-4 rounded-xl border border-slate-100 hover:bg-green-50 transition"><span class="text-sm font-bold text-green-700">Deposit</span></button>
                                <button @click="walletAction = 'withdrawal'" class="p-4 rounded-xl border border-slate-100 hover:bg-red-50 transition"><span class="text-sm font-bold text-red-700">Tarik</span></button>
                            </div>
                        </div>
                        
                        <!-- Transaction Form -->
                        <div x-show="walletAction" class="bg-white p-5 rounded-xl shadow-lg border border-indigo-50 relative">
                            <button @click="walletAction = null" class="absolute top-3 right-3 text-slate-400"><i class="fa-solid fa-xmark"></i></button>
                            <h3 class="font-bold mb-4 text-slate-800" x-text="walletAction === 'deposit' ? 'Form Deposit' : 'Form Penarikan'"></h3>
                            <form @submit.prevent="handleTransaction" class="space-y-4">
                                <input type="number" x-model="forms.transaction.amount" class="w-full px-4 py-3 border rounded-xl bg-slate-50 font-bold" placeholder="Nominal (Rp)" required>
                                <div x-show="walletAction === 'deposit'">
                                    <select x-model="forms.transaction.method" class="w-full px-4 py-3 border rounded-xl bg-slate-50 font-bold"><option value="Transfer Bank">Transfer Bank</option><option value="E-Wallet">E-Wallet</option></select>
                                </div>
                                <div x-show="walletAction === 'withdrawal'">
                                    <textarea x-model="forms.transaction.account_info" class="w-full px-4 py-3 border rounded-xl bg-slate-50" placeholder="Info Rekening"></textarea>
                                </div>
                                <button type="submit" class="w-full py-3.5 bg-primary text-white rounded-xl font-bold">KONFIRMASI</button>
                            </form>
                        </div>
                        
                         <!-- History -->
                        <div class="pb-10 space-y-3">
                            <h3 class="font-bold text-xs text-slate-400 uppercase">Riwayat</h3>
                            <template x-for="trx in history" :key="trx.id">
                                <div class="bg-white p-4 rounded-xl border border-slate-50 shadow-sm flex justify-between items-center">
                                    <div>
                                        <p class="text-xs font-bold text-slate-800 uppercase" x-text="trx.description || trx.type"></p>
                                        <p class="text-[10px] text-slate-400" x-text="new Date(trx.created_at).toLocaleDateString()"></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs font-bold" :class="['income','deposit'].includes(trx.type) ? 'text-green-600' : 'text-red-600'" x-text="(['income','deposit'].includes(trx.type) ? '+' : '-') + formatRupiah(trx.amount)"></p>
                                        <p class="text-[9px] uppercase font-bold" :class="trx.status === 'success' ? 'text-green-400' : 'text-orange-400'" x-text="trx.status"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- MEMBER: ACCOUNT -->
                     <div x-show="user.role === 'member' && view === 'account'" class="p-4 space-y-5 animate-fade-in">
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center text-2xl text-primary font-bold border-2 border-white shadow-sm">
                                <span x-text="user.username.substring(0,2).toUpperCase()"></span>
                            </div>
                            <div>
                                <h2 class="font-bold text-lg text-slate-800" x-text="user.username"></h2>
                                <p class="text-xs text-slate-500 mb-2" x-text="user.email"></p>
                            </div>
                        </div>
                         <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                             <p class="text-[10px] font-bold text-primary uppercase tracking-wider mb-2">Kode Referral</p>
                             <div class="flex gap-2">
                                <div class="flex-1 bg-slate-50 py-3 px-4 rounded-xl border border-dashed border-slate-300 font-mono text-center font-bold text-slate-700 tracking-widest select-all" x-text="user.referral_code"></div>
                                <button @click="copyRef" class="bg-secondary text-white px-5 rounded-xl text-xs font-bold">Salin</button>
                            </div>
                         </div>
                         <button @click="logout" class="w-full bg-white text-red-500 font-bold py-4 rounded-xl border border-red-100 shadow-sm mt-4">Keluar</button>
                     </div>

                    <!-- ADMIN VIEWS -->
                    <div x-show="user.role === 'admin' && view === 'admin_dash'" class="p-4 space-y-4 animate-fade-in">
                        <h2 class="text-2xl font-bold text-slate-800">Admin Dashboard</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-primary"><p class="text-xs font-bold uppercase text-slate-500">Users</p><p class="text-3xl font-bold" x-text="adminStats.total_users || 0"></p></div>
                            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500"><p class="text-xs font-bold uppercase text-slate-500">Deposit</p><p class="text-xl font-bold" x-text="formatRupiah(adminStats.total_deposit || 0)"></p></div>
                        </div>
                    </div>
                    
                    <div x-show="user.role === 'admin' && view === 'admin_users'" class="p-4 space-y-4 animate-fade-in">
                        <h2 class="text-2xl font-bold text-slate-800">Users</h2>
                        <div class="bg-white p-4 rounded-xl shadow overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead><tr class="border-b"><th class="p-2">ID</th><th class="p-2">User</th><th class="p-2">Plan</th><th class="p-2">Action</th></tr></thead>
                                <tbody>
                                    <template x-for="u in adminUsers" :key="u.id">
                                        <tr class="border-b">
                                            <td class="p-2" x-text="u.id"></td>
                                            <td class="p-2" x-text="u.username"></td>
                                            <td class="p-2" x-text="u.plan_name"></td>
                                            <td class="p-2"><button @click="toggleUserStatus(u.id, u.status)" class="text-blue-500 text-xs font-bold" x-text="u.status"></button></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div x-show="user.role === 'admin' && view === 'admin_plans'" class="p-4 space-y-4 animate-fade-in">
                         <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Plans</h2><button @click="showPlanModal=true" class="bg-primary text-white px-3 py-1 rounded">+ Plan</button></div>
                         <div class="space-y-3">
                             <template x-for="p in adminPlans" :key="p.id">
                                 <div class="bg-white p-4 rounded-xl shadow border border-slate-100">
                                     <h3 class="font-bold text-lg text-primary" x-text="p.name"></h3>
                                     <p class="text-sm text-slate-600" x-text="formatRupiah(p.price)"></p>
                                 </div>
                             </template>
                         </div>
                    </div>
                    
                    <div x-show="user.role === 'admin' && view === 'admin_jobs'" class="p-4 space-y-4 animate-fade-in">
                         <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">Jobs</h2><button @click="showJobModal=true" class="bg-primary text-white px-3 py-1 rounded">+ Job</button></div>
                         <div class="space-y-3">
                             <template x-for="j in adminJobs" :key="j.id">
                                 <div class="bg-white p-4 rounded-xl shadow border border-slate-100">
                                     <h3 class="font-bold text-sm truncate" x-text="j.title"></h3>
                                     <p class="text-xs text-green-600 font-bold" x-text="formatRupiah(j.reward_amount)"></p>
                                 </div>
                             </template>
                         </div>
                    </div>
                    
                     <!-- MODALS (Admin) -->
                    <div x-show="showPlanModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div @click.away="showPlanModal=false" class="bg-white w-full max-w-sm rounded-xl p-6">
                            <h3 class="font-bold mb-4">New Plan</h3>
                            <form @submit.prevent="createPlan" class="space-y-3">
                                <input x-model="forms.plan.name" class="w-full border p-2 rounded" placeholder="Name" required>
                                <input type="number" x-model="forms.plan.price" class="w-full border p-2 rounded" placeholder="Price" required>
                                <input type="number" x-model="forms.plan.duration" class="w-full border p-2 rounded" placeholder="Days" required>
                                <input type="number" x-model="forms.plan.daily_jobs" class="w-full border p-2 rounded" placeholder="Daily Jobs" required>
                                <input type="number" x-model="forms.plan.daily_income" class="w-full border p-2 rounded" placeholder="Daily Income" required>
                                <input type="number" x-model="forms.plan.video_seconds" class="w-full border p-2 rounded" placeholder="Video Secs" required>
                                <input x-model="forms.plan.thumbnail" class="w-full border p-2 rounded" placeholder="Thumbnail URL">
                                <div class="flex gap-2"><button type="button" @click="showPlanModal=false" class="flex-1 py-2 bg-slate-200 rounded">Cancel</button><button type="submit" class="flex-1 py-2 bg-primary text-white rounded">Save</button></div>
                            </form>
                        </div>
                    </div>
                     <div x-show="showJobModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div @click.away="showJobModal=false" class="bg-white w-full max-w-sm rounded-xl p-6">
                            <h3 class="font-bold mb-4">New Job</h3>
                            <form @submit.prevent="createJob" class="space-y-3">
                                <input x-model="forms.job.title" class="w-full border p-2 rounded" placeholder="Title" required>
                                <input x-model="forms.job.url" class="w-full border p-2 rounded" placeholder="Youtube URL" required>
                                <input type="number" x-model="forms.job.reward" class="w-full border p-2 rounded" placeholder="Reward" required>
                                <input type="number" x-model="forms.job.min_level" class="w-full border p-2 rounded" placeholder="Min Level ID" required>
                                <div class="flex gap-2"><button type="button" @click="showJobModal=false" class="flex-1 py-2 bg-slate-200 rounded">Cancel</button><button type="submit" class="flex-1 py-2 bg-primary text-white rounded">Save</button></div>
                            </form>
                        </div>
                    </div>

                </main>

                <!-- NAV BAR -->
                <nav class="absolute bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around items-center h-[70px] pb-safe z-40 shadow" x-show="view !== 'do_job'">
                     <template x-if="user.role === 'member'">
                        <div class="contents">
                            <button @click="changeView('home')" :class="view==='home'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Home</span></button>
                            <button @click="changeView('jobs')" :class="['jobs','do_job'].includes(view)?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-play-circle text-xl"></i><span class="text-[10px] font-bold">Misi</span></button>
                            <button @click="changeView('plans')" class="relative -top-5 bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-white"><i class="fa-solid fa-crown text-xl"></i></button>
                            <button @click="changeView('wallet')" :class="view==='wallet'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold">Dompet</span></button>
                            <button @click="changeView('account')" :class="view==='account'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Akun</span></button>
                        </div>
                     </template>
                     <template x-if="user.role === 'admin'">
                         <div class="contents">
                            <button @click="changeView('admin_dash')" :class="view==='admin_dash'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-chart-pie"></i><span class="text-[10px]">Dash</span></button>
                            <button @click="changeView('admin_users')" :class="view==='admin_users'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-users"></i><span class="text-[10px]">User</span></button>
                            <button @click="changeView('admin_plans')" :class="view==='admin_plans'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-crown"></i><span class="text-[10px]">Plan</span></button>
                            <button @click="changeView('admin_jobs')" :class="view==='admin_jobs'?'text-primary':'text-slate-400'" class="flex flex-col items-center gap-1 w-16"><i class="fa-solid fa-video"></i><span class="text-[10px]">Job</span></button>
                         </div>
                     </template>
                </nav>
            </div>
        </template>
    </div>
</body>
</html>
