<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for better aesthetics */
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased min-h-screen p-4 sm:p-8">

    <!-- Main application container with x-data -->
    <!-- The errors are fixed because 'membershipApp()' is now defined globally in the script module -->
    <div 
        class="max-w-4xl mx-auto bg-gray-800 p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-700"
        x-data="membershipApp()"
        x-cloak
        x-init="init()"
    >
        <h1 class="text-4xl font-bold mb-6 text-indigo-400">Secure Membership Portal</h1>
        <p class="mb-8 text-gray-400">Powered by Alpine.js and Firebase Firestore.</p>

        <!-- Loading State -->
        <div x-if="loading" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-indigo-300">Establishing connection...</p>
        </div>

        <!-- Authentication Required View (x-if="!loggedIn" fixed) -->
        <template x-if="!loggedIn && !loading">
            <div class="text-center bg-gray-700 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold text-red-400 mb-3">Authentication Error</h2>
                <p class="text-gray-300">Could not establish a secure session. Please check Firebase configuration.</p>
                <p class="mt-4 text-sm text-gray-500">
                    User ID will be automatically generated.
                </p>
            </div>
        </template>

        <!-- Logged In View (x-if="loggedIn" fixed) -->
        <template x-if="loggedIn && !loading">
            <div class="space-y-6">
                <div class="bg-indigo-900/30 p-4 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm text-indigo-300">Current User ID:</p>
                        <p class="font-mono text-xs break-all text-indigo-100" x-text="userId"></p>
                    </div>
                </div>

                <!-- Membership Data Section -->
                <h2 class="text-2xl font-semibold text-gray-200 border-b border-gray-700 pb-2">Your Membership Status</h2>
                
                <div class="space-y-4">
                    <div x-if="membershipData" class="bg-gray-700 p-5 rounded-lg shadow-md">
                        <p class="text-xl font-bold" x-text="membershipData.plan"></p>
                        <p class="text-gray-400">Since: <span x-text="new Date(membershipData.joinDate).toLocaleDateString()"></span></p>
                        <p class="mt-2" :class="membershipData.active ? 'text-green-400' : 'text-red-400'">
                            Status: <span x-text="membershipData.active ? 'Active' : 'Inactive'"></span>
                        </p>
                        <button @click="updateMembership" class="mt-4 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium transition duration-150">
                            Update Plan (Demo)
                        </button>
                    </div>
                    <div x-if="!membershipData" class="text-center p-6 border-2 border-dashed border-gray-600 rounded-lg text-gray-400">
                        <p>No membership data found. Setting up initial data...</p>
                        <button @click="createInitialData" class="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-medium transition duration-150">
                            Create Membership Record
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
    </div>

    <!-- Load Alpine.js at the end of the body for best practice, with defer -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>

    <!-- Firebase Initialization and Alpine Component Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let unsubscribe = () => {}; // Placeholder for the Firestore listener cleanup function

        // Expose the Alpine component function globally
        window.membershipApp = function() {
            return {
                loading: true,
                loggedIn: false,
                userId: 'N/A',
                membershipData: null,
                
                init() {
                    console.log("App initializing...");
                    // 1. Initialize Firebase App
                    try {
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                    } catch (e) {
                        console.error("Firebase initialization failed:", e);
                        this.loading = false;
                        return;
                    }

                    // 2. Handle Authentication
                    onAuthStateChanged(auth, async (user) => {
                        this.loading = true;
                        if (user) {
                            // User is signed in
                            userId = user.uid;
                            this.userId = userId;
                            this.loggedIn = true;
                            console.log("Auth state changed. User ID:", userId);

                            // 3. Start Firestore Listener for Membership Data
                            this.startDataListener(userId);
                            this.loading = false;

                        } else {
                            // User is signed out or first time load. Sign in.
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    // Fallback to anonymous sign-in if token is missing
                                    await signInAnonymously(auth);
                                }
                                // The onAuthStateChanged listener will catch the successful sign-in
                            } catch (error) {
                                console.error("Authentication failed:", error);
                                this.loggedIn = false;
                                this.loading = false;
                            }
                        }
                    });
                },

                startDataListener(uid) {
                    // Stop previous listener if exists
                    unsubscribe(); 

                    // Define the document path: private data for the current user
                    // Path: /artifacts/{appId}/users/{userId}/membershipData/status
                    const docPath = `/artifacts/${appId}/users/${uid}/membershipData/status`;
                    const statusRef = doc(db, docPath);

                    // Set up real-time listener
                    unsubscribe = onSnapshot(statusRef, (docSnap) => {
                        if (docSnap.exists()) {
                            console.log("Membership data received:", docSnap.data());
                            this.membershipData = docSnap.data();
                        } else {
                            console.log("No membership data found in Firestore.");
                            this.membershipData = null;
                        }
                    }, (error) => {
                        console.error("Firestore subscription error:", error);
                    });
                },

                async createInitialData() {
                    if (!db || !this.userId) return;

                    const initialData = {
                        plan: 'Basic',
                        active: true,
                        joinDate: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    
                    const docPath = `/artifacts/${appId}/users/${this.userId}/membershipData/status`;
                    try {
                        await setDoc(doc(db, docPath), initialData);
                        console.log("Initial data created successfully.");
                    } catch (e) {
                        console.error("Error creating document:", e);
                    }
                },

                async updateMembership() {
                    if (!db || !this.userId || !this.membershipData) return;
                    
                    const docPath = `/artifacts/${appId}/users/${this.userId}/membershipData/status`;
                    const newPlan = this.membershipData.plan === 'Basic' ? 'Premium' : 'Basic';
                    
                    const newData = {
                        ...this.membershipData,
                        plan: newPlan,
                        lastUpdated: new Date().toISOString()
                    };

                    try {
                        await setDoc(doc(db, docPath), newData); // Using setDoc to fully replace/update
                        console.log(`Membership updated to ${newPlan}.`);
                    } catch (e) {
                        console.error("Error updating document:", e);
                    }
                }
            }
        }
    </script>
</body>
</html>
