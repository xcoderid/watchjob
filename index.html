<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AdView Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#6366f1', secondary: '#1e293b', accent: '#f59e0b' },
                    animation: { 'marquee': 'marquee 20s linear infinite' },
                    keyframes: { marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } } }
                }
            }
        }
    </script>

    <!-- LOGIKA APLIKASI UTAMA -->
    <script>
        function app() {
            return {
                // State Awal
                authMode: 'login',
                view: 'home',
                adminView: 'stats', // Default view admin
                token: localStorage.getItem('token'),
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                loading: false,
                toast: { show: false, msg: '', type: 'success' },
                
                // Data
                jobs: [], 
                plansList: [], 
                completedIds: [], 
                history: [], 
                plan: null, 
                settings: { running_text: '', l1: 0, l2: 0, l3: 0 },
                
                // Player
                activeJob: null, 
                timer: 0, 
                isFocused: true, 
                interval: null,
                
                // Admin Data
                adminData: { 
                    stats: { users:0, deposit:0, pending_wd:0, pending_depo:0 }, 
                    users: [], 
                    pending_tx: [] 
                },

                // Forms
                forms: {
                    auth: { username: '', password: '', email: '', referral_code: '' },
                    job: { title: '', url: '', min_plan: 1 },
                    settings: { l1: 10, l2: 5, l3: 2, running_text: '' },
                    transaction: { amount: '', method: 'Transfer Bank', account_info: '' },
                    plan: { name: '', price: '', duration: 30, daily_jobs: 10, commission: 500, return_capital: false, thumbnail: '' }
                },

                async init() {
                    if (this.token) {
                        await this.fetchUserData();
                        await this.fetchHistory();
                        await this.fetchSettings();
                    }
                    document.addEventListener("visibilitychange", () => { this.isFocused = !document.hidden; });
                },

                // --- API Helper ---
                async req(url, method = 'GET', body = null) {
                    const headers = { 'Content-Type': 'application/json' };
                    if (this.token) headers['Authorization'] = `Bearer ${this.token}`;
                    try {
                        const res = await fetch(`/api${url}`, { method, headers, body: body ? JSON.stringify(body) : null });
                        const json = await res.json();
                        if (!res.ok) throw new Error(json.error || 'Terjadi kesalahan');
                        return json;
                    } catch (e) {
                        this.showToast(e.message, 'error');
                        throw e;
                    }
                },

                // --- Auth ---
                async authSubmit() {
                    this.loading = true;
                    try {
                        const res = await this.req(`/auth?type=${this.authMode}`, 'POST', this.forms.auth);
                        if (this.authMode === 'login') {
                            this.token = res.token;
                            this.user = res.user;
                            localStorage.setItem('token', res.token);
                            localStorage.setItem('user', JSON.stringify(res.user));
                            await this.fetchUserData();
                            this.view = this.user.role === 'admin' ? 'admin' : 'home';
                        } else {
                            this.showToast('Pendaftaran sukses, silakan login');
                            this.authMode = 'login';
                        }
                    } catch (e) {} finally { this.loading = false; }
                },
                logout() { localStorage.clear(); location.reload(); },

                // --- Data Fetching ---
                async fetchUserData() {
                    if(!this.user) return;
                    try {
                        const res = await this.req(`/users?id=${this.user.id}`);
                        this.user = { ...this.user, ...res.user };
                        this.plan = res.plan;
                        
                        if(this.user.role === 'member') {
                            const jRes = await this.req(`/jobs?user_id=${this.user.id}`);
                            this.jobs = jRes.jobs; 
                            this.completedIds = jRes.completed_ids;
                            this.plansList = await this.req('/plans');
                        }
                    } catch (e) { if(e.message.includes('found')) this.logout(); }
                },
                async fetchHistory() { 
                    if(this.user && this.user.role === 'member') {
                        try { this.history = await this.req(`/transactions?user_id=${this.user.id}`); } catch(e){} 
                    }
                },
                async fetchSettings() { 
                    try { 
                        this.settings = await this.req('/admin?type=settings'); 
                    } catch(e){} 
                },

                // --- Member Actions ---
                async handleTransaction(type) {
                    const f = this.forms.transaction;
                    if(!f.amount || f.amount <= 0) return this.showToast('Nominal tidak valid', 'error');
                    try {
                        await this.req('/transactions', 'POST', { 
                            user_id: this.user.id, type, amount: parseFloat(f.amount), 
                            method: f.method, account_info: f.account_info 
                        });
                        this.showToast(`${type === 'deposit' ? 'Deposit' : 'Penarikan'} Berhasil Diajukan`);
                        this.fetchUserData(); 
                        this.fetchHistory();
                        this.forms.transaction.amount = '';
                        this.forms.transaction.account_info = '';
                    } catch(e){}
                },
                async buyPlan(plan, code) {
                    if(!confirm(`Beli paket ${plan.name}?`)) return;
                    try {
                        await this.req('/plans', 'POST', { user_id: this.user.id, plan_id: plan.id, coupon_code: code });
                        this.showToast('Upgrade Berhasil!'); 
                        this.fetchUserData();
                    } catch(e){}
                },

                // --- Admin Actions ---
                async loadAdminData() {
                    this.adminData.stats = await this.req('/admin?type=stats');
                    this.adminData.users = await this.req('/admin?type=users');
                    this.adminData.pending_tx = await this.req('/admin?type=pending_tx');
                    
                    // Load current settings to form
                    const s = await this.req('/admin?type=settings');
                    this.forms.settings.l1 = s.affiliate_l1; 
                    this.forms.settings.l2 = s.affiliate_l2; 
                    this.forms.settings.l3 = s.affiliate_l3;
                    this.forms.settings.running_text = s.running_text;
                },
                async processTx(id, decision) {
                    if(!confirm(decision === 'approve' ? 'Setujui transaksi?' : 'Tolak transaksi?')) return;
                    try {
                        await this.req('/admin', 'POST', { action: 'process_tx', tx_id: id, decision });
                        this.showToast('Transaksi diproses');
                        this.loadAdminData(); // Refresh list
                    } catch(e){}
                },
                async createJob() {
                    await this.req('/admin', 'POST', { action: 'create_job', ...this.forms.job });
                    this.showToast('Job berhasil ditambahkan'); 
                    this.forms.job.title = '';
                },
                async createPlan() {
                    const p = this.forms.plan;
                    await this.req('/admin', 'POST', { 
                        action: 'create_plan', 
                        name: p.name, price: parseFloat(p.price)||0, duration: parseInt(p.duration)||30,
                        daily_jobs: parseInt(p.daily_jobs)||1, commission: parseFloat(p.commission)||0,
                        return_capital: p.return_capital, thumbnail: p.thumbnail
                    });
                    this.showToast('Paket berhasil dibuat'); 
                    this.adminView = 'stats';
                },
                async saveSettings() {
                    await this.req('/admin', 'POST', { action: 'update_settings', ...this.forms.settings });
                    this.showToast('Pengaturan disimpan'); 
                    this.fetchSettings();
                },
                async toggleUser(uid, status) {
                    await this.req('/admin', 'POST', { action: 'user_action', user_id: uid, type: status==='active'?'ban':'unban' });
                    this.loadAdminData();
                },

                // --- Player ---
                getVidId(url) { if (!url) return ''; const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); return (match && match[2].length === 11) ? match[2] : null; },
                startJob(job) { this.activeJob = job; this.timer = job.duration; this.view = 'do_job'; this.isFocused = true; if(this.interval) clearInterval(this.interval); this.interval = setInterval(() => { if (this.isFocused && this.timer > 0) this.timer--; if (this.timer <= 0) clearInterval(this.interval); }, 1000); },
                stopJob() { clearInterval(this.interval); this.activeJob = null; this.view = 'jobs'; },
                async claimJob() { try { await this.req('/jobs', 'POST', { action: 'claim', user_id: this.user.id, job_id: this.activeJob.id }); this.showToast('Saldo masuk!'); this.stopJob(); this.fetchUserData(); } catch(e){} },

                // --- Utils ---
                copyRef() { navigator.clipboard.writeText(this.user.referral_code); this.showToast('Disalin'); },
                formatIdr(n) { return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", maximumFractionDigits: 0 }).format(n || 0); },
                showToast(msg, type='success') { this.toast = { show: true, msg, type }; setTimeout(() => this.toast.show = false, 3000); }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style> [x-cloak] { display: none !important; } .no-scrollbar::-webkit-scrollbar { display: none; } iframe { pointer-events: none; } .pb-safe { padding-bottom: env(safe-area-inset-bottom); } </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased flex flex-col h-screen overflow-hidden" x-data="app()" x-init="init()">

    <!-- Toast -->
    <div class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[100]" x-cloak x-show="toast.show" x-transition.opacity.duration.300ms>
        <div :class="toast.type === 'error' ? 'bg-red-500' : 'bg-green-500'" class="text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 font-bold text-xs">
            <i :class="toast.type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check'" class="fa-solid"></i>
            <span x-text="toast.msg"></span>
        </div>
    </div>

    <!-- Auth Overlay -->
    <template x-if="!token">
        <div class="fixed inset-0 bg-white z-[60] flex flex-col justify-center p-8">
            <div class="text-center mb-10"><h1 class="text-3xl font-bold text-primary">AdView Pro</h1><p class="text-slate-400 text-sm">Platform Kerja Online</p></div>
            <div class="bg-slate-100 p-1 rounded-lg flex mb-6"><button @click="authMode='login'" :class="authMode==='login'?'bg-white shadow text-primary':'text-slate-400'" class="flex-1 py-2 font-bold text-sm rounded">Masuk</button><button @click="authMode='register'" :class="authMode==='register'?'bg-white shadow text-primary':'text-slate-400'" class="flex-1 py-2 font-bold text-sm rounded">Daftar</button></div>
            <form @submit.prevent="authSubmit" class="space-y-4">
                <input x-model="forms.auth.username" type="text" placeholder="Username" class="w-full p-3 border rounded-lg text-sm bg-slate-50" required>
                <div x-show="authMode==='register'"><input x-model="forms.auth.email" type="email" placeholder="Email" class="w-full p-3 border rounded-lg text-sm bg-slate-50 mb-4"><input x-model="forms.auth.referral_code" type="text" placeholder="Kode Referral" class="w-full p-3 border rounded-lg text-sm bg-slate-50 mb-4"></div>
                <input x-model="forms.auth.password" type="password" placeholder="Password" class="w-full p-3 border rounded-lg text-sm bg-slate-50" required>
                <button type="submit" class="w-full py-3 bg-primary text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition" :disabled="loading" x-text="loading ? 'Memuat...' : (authMode==='login'?'MASUK':'DAFTAR')"></button>
            </form>
        </div>
    </template>

    <!-- Main App -->
    <div class="flex-1 flex flex-col w-full max-w-md mx-auto bg-white shadow-2xl h-full relative" x-show="token && user">
        
        <!-- Header -->
        <header class="bg-white p-4 flex justify-between items-center border-b z-20" x-show="view !== 'do_job'">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-primary font-bold text-xs border border-indigo-200" x-text="user?.username?.substring(0,2).toUpperCase()"></div>
                <div><p class="text-[10px] text-slate-400 font-bold uppercase">Saldo Anda</p><p class="font-bold text-sm" x-text="formatIdr(user?.balance)"></p></div>
            </div>
            <span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-[10px] font-bold border border-amber-200" x-text="plan?.name || 'Free'"></span>
        </header>

        <!-- Running Text -->
        <div x-show="view==='home'" class="bg-slate-800 text-white text-[10px] py-2 overflow-hidden whitespace-nowrap relative z-10"><div class="inline-block animate-marquee" x-text="settings.running_text || 'Selamat Datang di AdView Pro'"></div></div>

        <!-- Content Scrollable -->
        <main class="flex-1 overflow-y-auto bg-slate-50 pb-24 relative">
            
            <!-- MEMBER: HOME -->
            <div x-show="view==='home'" class="p-4 space-y-4 animate-fade-in">
                <div class="bg-gradient-to-r from-primary to-indigo-600 rounded-xl p-5 text-white shadow-lg">
                    <p class="text-xs opacity-80 mb-1">Penghasilan Hari Ini</p>
                    <h2 class="text-2xl font-bold mb-3" x-text="formatIdr(user?.today_income)"></h2>
                    <button @click="view='plans'" class="bg-white/20 backdrop-blur border border-white/30 px-4 py-1.5 rounded-lg text-xs font-bold">Upgrade VIP</button>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button @click="view='jobs'" class="bg-white p-3 rounded-lg shadow-sm border flex flex-col items-center gap-1"><i class="fa-brands fa-youtube text-red-500 text-xl"></i><span class="text-[10px]">Misi</span></button>
                    <button @click="view='deposit'" class="bg-white p-3 rounded-lg shadow-sm border flex flex-col items-center gap-1"><i class="fa-solid fa-wallet text-green-500 text-xl"></i><span class="text-[10px]">Isi</span></button>
                    <button @click="view='withdraw'" class="bg-white p-3 rounded-lg shadow-sm border flex flex-col items-center gap-1"><i class="fa-solid fa-building-columns text-blue-500 text-xl"></i><span class="text-[10px]">Tarik</span></button>
                    <button @click="view='referral'" class="bg-white p-3 rounded-lg shadow-sm border flex flex-col items-center gap-1"><i class="fa-solid fa-users text-amber-500 text-xl"></i><span class="text-[10px]">Tim</span></button>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <h3 class="font-bold text-xs mb-3 uppercase text-slate-400">Transaksi Terakhir</h3>
                    <div class="space-y-3">
                        <template x-for="t in history.slice(0, 5)" :key="t.id">
                            <div class="flex justify-between items-center text-xs border-b pb-2 last:border-0">
                                <div><p class="font-bold" x-text="t.type.toUpperCase()"></p><p class="text-[10px] text-slate-400" x-text="new Date(t.created_at).toLocaleDateString()"></p></div>
                                <div class="text-right">
                                    <p class="font-bold" :class="['deposit','income'].includes(t.type)?'text-green-600':'text-red-600'" x-text="formatIdr(t.amount)"></p>
                                    <span class="text-[10px] px-2 py-0.5 rounded" :class="t.status==='success'?'bg-green-100 text-green-700':(t.status==='pending'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700')" x-text="t.status"></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="!history.length" class="text-center text-xs text-slate-400 py-4">Belum ada transaksi</div>
                    </div>
                </div>
            </div>

            <!-- MEMBER: JOBS -->
            <div x-show="view==='jobs'" class="p-4 space-y-3">
                <h2 class="font-bold text-sm uppercase text-slate-500">Daftar Misi</h2>
                <template x-for="job in jobs" :key="job.id">
                    <div class="bg-white p-3 rounded-xl shadow-sm border flex gap-3 items-center relative overflow-hidden">
                        <div class="w-24 h-16 bg-black rounded-lg overflow-hidden flex-shrink-0 relative">
                            <img :src="'https://img.youtube.com/vi/'+getVidId(job.youtube_url)+'/mqdefault.jpg'" class="w-full h-full object-cover opacity-80">
                            <div class="absolute inset-0 flex items-center justify-center text-white"><i class="fa-solid fa-play"></i></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-xs truncate" x-text="job.title"></h3>
                            <div class="flex gap-2 mt-1 text-[10px] text-slate-500">
                                <span class="bg-slate-100 px-1.5 rounded"><i class="fa-regular fa-clock"></i> <span x-text="job.duration"></span>s</span>
                                <span class="text-green-600 font-bold" x-text="'+ '+formatIdr(plan?.commission)"></span>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                             <span x-show="completedIds.includes(job.id)" class="text-green-500 text-xl"><i class="fa-solid fa-circle-check"></i></span>
                             <button x-show="!completedIds.includes(job.id)" @click="startJob(job)" class="bg-primary text-white text-xs font-bold px-3 py-1.5 rounded shadow">Play</button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- MEMBER: DEPOSIT -->
            <div x-show="view==='deposit'" class="p-4 space-y-4">
                <h2 class="font-bold text-sm uppercase text-slate-500">Isi Saldo</h2>
                <div class="bg-white p-5 rounded-xl shadow-sm border">
                    <form @submit.prevent="handleTransaction('deposit')" class="space-y-4">
                        <div><label class="text-xs font-bold block mb-1">Metode</label><select x-model="forms.transaction.method" class="w-full p-2 text-sm border rounded bg-slate-50"><option>Transfer Bank</option><option>E-Wallet</option></select></div>
                        <div><label class="text-xs font-bold block mb-1">Nominal</label><input x-model="forms.transaction.amount" type="number" class="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Contoh: 50000"></div>
                        <button type="submit" class="w-full py-2 bg-green-500 text-white rounded font-bold text-sm">Konfirmasi Deposit</button>
                    </form>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-100 text-xs text-yellow-800">Deposit akan diproses Admin (status Pending). Saldo masuk setelah disetujui.</div>
            </div>

            <!-- MEMBER: WITHDRAW -->
            <div x-show="view==='withdraw'" class="p-4 space-y-4">
                <h2 class="font-bold text-sm uppercase text-slate-500">Tarik Dana</h2>
                <div class="bg-white p-5 rounded-xl shadow-sm border">
                    <div class="text-center mb-4"><p class="text-xs text-slate-400">Saldo Aktif</p><h3 class="text-xl font-bold" x-text="formatIdr(user?.balance)"></h3></div>
                    <form @submit.prevent="handleTransaction('withdrawal')" class="space-y-4">
                        <div><label class="text-xs font-bold block mb-1">Nominal</label><input x-model="forms.transaction.amount" type="number" class="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Min. 50000"></div>
                        <div><label class="text-xs font-bold block mb-1">Info Rekening</label><textarea x-model="forms.transaction.account_info" class="w-full p-2 text-sm border rounded bg-slate-50" placeholder="Bank/Wallet - No.Rek - Atas Nama"></textarea></div>
                        <button type="submit" class="w-full py-2 bg-slate-800 text-white rounded font-bold text-sm">Ajukan Penarikan</button>
                    </form>
                </div>
            </div>

            <!-- MEMBER: PLANS -->
            <div x-show="view==='plans'" class="p-4 space-y-4">
                <h2 class="font-bold text-sm uppercase text-slate-500">Pilih Paket</h2>
                <template x-for="p in plansList" :key="p.id">
                    <div class="bg-white rounded-xl overflow-hidden shadow-sm border relative">
                        <div class="h-28 bg-slate-200 relative">
                            <img :src="p.thumbnail_url" class="w-full h-full object-cover" onerror="this.style.display='none'">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end p-3"><h3 class="text-white font-bold" x-text="p.name"></h3></div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-2"><p class="text-primary font-bold" x-text="formatIdr(p.price)"></p><span class="text-xs bg-slate-100 px-2 py-1 rounded" x-text="p.duration_days+' Hari'"></span></div>
                            <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-500 mb-3">
                                <div class="bg-slate-50 p-1 rounded text-center">Job: <b x-text="p.daily_jobs_limit"></b> /hari</div>
                                <div class="bg-slate-50 p-1 rounded text-center">Komisi: <b x-text="formatIdr(p.commission)"></b></div>
                            </div>
                            <div class="flex gap-2">
                                <input x-model="code" placeholder="Kode Kupon" class="flex-1 p-2 text-xs border rounded" x-data="{code:''}">
                                <button @click="buyPlan(p, $el.previousElementSibling.value)" class="bg-secondary text-white px-4 py-2 rounded text-xs font-bold">BELI</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- MEMBER: REFERRAL -->
            <div x-show="view==='referral'" class="p-4 space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border text-center">
                    <p class="text-xs text-slate-400">Kode Referral Anda</p>
                    <h2 class="text-2xl font-bold my-2 text-primary tracking-widest" x-text="user?.referral_code"></h2>
                    <button @click="copyRef" class="text-xs bg-slate-100 px-3 py-1 rounded">Salin</button>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <h3 class="font-bold text-xs mb-3 uppercase text-slate-400">Skema Bonus</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between border-b pb-1"><span>Level 1</span><b x-text="settings.l1+'%'"></b></div>
                        <div class="flex justify-between border-b pb-1"><span>Level 2</span><b x-text="settings.l2+'%'"></b></div>
                        <div class="flex justify-between"><span>Level 3</span><b x-text="settings.l3+'%'"></b></div>
                    </div>
                </div>
            </div>

            <!-- ADMIN DASHBOARD -->
            <div x-show="view==='admin'" class="p-4 pb-24 space-y-6">
                <div class="flex justify-between items-center"><h2 class="font-bold text-lg">Admin Dashboard</h2><button @click="logout" class="text-xs text-red-500 font-bold">Logout</button></div>
                
                <!-- Stats -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-lg shadow border-l-4 border-blue-500"><p class="text-[10px] text-slate-400">Total User</p><h3 class="font-bold text-lg" x-text="adminData.stats.users"></h3></div>
                    <div class="bg-white p-3 rounded-lg shadow border-l-4 border-green-500"><p class="text-[10px] text-slate-400">Deposit Sukses</p><h3 class="font-bold text-lg" x-text="formatIdr(adminData.stats.deposit)"></h3></div>
                </div>

                <!-- Menu Admin -->
                <div class="grid grid-cols-3 gap-2">
                    <button @click="adminView='pending_tx'" class="bg-slate-800 text-white py-2 rounded text-xs font-bold relative">
                        Approval 
                        <span x-show="(adminData.stats.pending_wd + adminData.stats.pending_depo) > 0" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></span>
                    </button>
                    <button @click="adminView='users'" class="bg-white border py-2 rounded text-xs font-bold">Users</button>
                    <button @click="adminView='settings'" class="bg-white border py-2 rounded text-xs font-bold">Settings</button>
                    <button @click="adminView='add_job'" class="bg-white border py-2 rounded text-xs font-bold">Add Job</button>
                    <button @click="adminView='create_plan'" class="bg-white border py-2 rounded text-xs font-bold">Add Plan</button>
                </div>

                <!-- Admin Subviews -->
                
                <!-- Approval List -->
                <div x-show="adminView==='pending_tx'" class="space-y-3">
                    <h3 class="font-bold text-xs uppercase text-slate-500">Pending Transactions</h3>
                    <div x-show="!adminData.pending_tx.length" class="text-center text-xs text-slate-400 py-4">Tidak ada transaksi pending.</div>
                    <template x-for="tx in adminData.pending_tx" :key="tx.id">
                        <div class="bg-white p-3 rounded-lg shadow-sm border">
                            <div class="flex justify-between mb-1"><span class="font-bold text-xs uppercase" :class="tx.type==='deposit'?'text-green-600':'text-red-600'" x-text="tx.type"></span><span class="text-[10px] text-slate-400" x-text="new Date(tx.created_at).toLocaleString()"></span></div>
                            <div class="flex justify-between items-center mb-2">
                                <div><p class="font-bold text-sm" x-text="tx.username"></p><p class="text-xs font-bold" x-text="formatIdr(tx.amount)"></p></div>
                                <p class="text-[10px] bg-slate-100 px-2 py-1 rounded max-w-[120px] truncate" x-text="tx.description"></p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="processTx(tx.id, 'approve')" class="flex-1 bg-green-500 text-white py-1.5 rounded text-xs font-bold">TERIMA</button>
                                <button @click="processTx(tx.id, 'reject')" class="flex-1 bg-red-500 text-white py-1.5 rounded text-xs font-bold">TOLAK</button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Users List -->
                <div x-show="adminView==='users'" class="bg-white rounded-lg shadow overflow-hidden">
                     <div class="p-3 bg-slate-50 border-b font-bold text-xs">User Management</div>
                     <div class="max-h-80 overflow-y-auto">
                        <template x-for="u in adminData.users" :key="u.id">
                            <div class="p-3 border-b flex justify-between items-center text-xs">
                                <div><p class="font-bold" x-text="u.username"></p><p class="text-slate-400" x-text="formatIdr(u.balance)"></p></div>
                                <button @click="toggleUser(u.id, u.status)" class="px-2 py-1 rounded text-[10px] font-bold text-white" :class="u.status==='active'?'bg-red-500':'bg-green-500'" x-text="u.status==='active'?'BAN':'UNBAN'"></button>
                            </div>
                        </template>
                     </div>
                </div>

                <!-- Settings -->
                <div x-show="adminView==='settings'" class="bg-white p-4 rounded-lg shadow border">
                    <h3 class="font-bold text-xs uppercase mb-3">Pengaturan Global</h3>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold">Running Text</label><textarea x-model="forms.settings.running_text" class="w-full p-2 border rounded text-xs"></textarea></div>
                        <div class="grid grid-cols-3 gap-2">
                            <div><label class="text-xs">L1 %</label><input x-model="forms.settings.l1" class="w-full p-2 border rounded text-xs"></div>
                            <div><label class="text-xs">L2 %</label><input x-model="forms.settings.l2" class="w-full p-2 border rounded text-xs"></div>
                            <div><label class="text-xs">L3 %</label><input x-model="forms.settings.l3" class="w-full p-2 border rounded text-xs"></div>
                        </div>
                        <button @click="saveSettings" class="w-full py-2 bg-primary text-white rounded font-bold text-xs">SIMPAN</button>
                    </div>
                </div>

                 <!-- Add Job -->
                 <div x-show="adminView==='add_job'" class="bg-white p-4 rounded-lg shadow border">
                    <h3 class="font-bold text-xs uppercase mb-3">Tambah Misi Video</h3>
                    <div class="space-y-3">
                        <input x-model="forms.job.url" placeholder="Link Youtube" class="w-full p-2 border rounded text-xs">
                        <input x-model="forms.job.title" placeholder="Judul Video" class="w-full p-2 border rounded text-xs">
                        <select x-model="forms.job.min_plan" class="w-full p-2 border rounded text-xs"><template x-for="p in plansList" :key="p.id"><option :value="p.id" x-text="p.name"></option></template></select>
                        <button @click="createJob" class="w-full py-2 bg-primary text-white rounded font-bold text-xs">POSTING</button>
                    </div>
                </div>

                 <!-- Create Plan -->
                 <div x-show="adminView==='create_plan'" class="bg-white p-4 rounded-lg shadow border">
                    <h3 class="font-bold text-xs uppercase mb-3">Buat Paket Level</h3>
                    <div class="space-y-3">
                        <input x-model="forms.plan.name" placeholder="Nama Paket" class="w-full p-2 border rounded text-xs">
                        <input x-model="forms.plan.price" type="number" placeholder="Harga" class="w-full p-2 border rounded text-xs">
                        <div class="grid grid-cols-2 gap-2">
                            <input x-model="forms.plan.duration" type="number" placeholder="Durasi (Hari)" class="w-full p-2 border rounded text-xs">
                            <input x-model="forms.plan.daily_jobs" type="number" placeholder="Job/Hari" class="w-full p-2 border rounded text-xs">
                        </div>
                        <input x-model="forms.plan.commission" type="number" placeholder="Komisi" class="w-full p-2 border rounded text-xs">
                        <input x-model="forms.plan.thumbnail" placeholder="URL Thumbnail" class="w-full p-2 border rounded text-xs">
                        <button @click="createPlan" class="w-full py-2 bg-primary text-white rounded font-bold text-xs">BUAT PAKET</button>
                    </div>
                </div>

            </div>
        </main>

        <!-- Player Modal -->
        <div x-show="view==='do_job'" class="fixed inset-0 bg-black z-50 flex flex-col">
            <div class="p-4 flex justify-between items-center text-white z-10"><button @click="stopJob" class="bg-white/20 px-3 py-1 rounded text-xs font-bold">Keluar</button><span class="bg-red-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse" x-text="timer+'s'"></span></div>
            <div x-show="!isFocused" class="absolute inset-0 z-20 bg-black/95 flex flex-col items-center justify-center text-white text-center"><p>Dilarang pindah tab!</p></div>
            <div class="flex-1 flex items-center justify-center"><div id="player-container" class="w-full aspect-video pointer-events-none"><iframe :src="'https://www.youtube.com/embed/'+getVidId(activeJob?.youtube_url)+'?autoplay=1&controls=0&rel=0&playsinline=1&enablejsapi=1'" class="w-full h-full" frameborder="0" allow="autoplay"></iframe></div></div>
            <div class="p-6 bg-slate-900 text-white rounded-t-2xl"><h3 class="font-bold truncate mb-4" x-text="activeJob?.title"></h3><button x-show="timer <= 0" @click="claimJob" class="w-full py-3 bg-green-500 font-bold rounded-lg shadow-lg">KLAIM</button><button x-show="timer > 0" disabled class="w-full py-3 bg-slate-800 text-slate-500 font-bold rounded-lg">Tonton Dulu...</button></div>
        </div>

        <!-- Bottom Nav -->
        <nav class="bg-white border-t flex justify-around items-center py-2 sticky bottom-0 pb-safe z-40 shadow-lg" x-show="view !== 'do_job' && token">
            <template x-if="user?.role === 'member'">
                <div class="contents">
                    <button @click="view='home'" :class="view==='home'?'text-primary':'text-slate-400'" class="flex flex-col items-center w-16 gap-1"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Home</span></button>
                    <button @click="view='jobs'" :class="view==='jobs'?'text-primary':'text-slate-400'" class="flex flex-col items-center w-16 gap-1"><i class="fa-solid fa-play-circle text-xl"></i><span class="text-[10px] font-bold">Misi</span></button>
                    <button @click="view='plans'" class="relative -top-5 bg-secondary text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-4 border-slate-100"><i class="fa-solid fa-crown text-lg"></i></button>
                    <button @click="view='referral'" :class="view==='referral'?'text-primary':'text-slate-400'" class="flex flex-col items-center w-16 gap-1"><i class="fa-solid fa-users text-xl"></i><span class="text-[10px] font-bold">Tim</span></button>
                    <button @click="logout" class="text-slate-400 flex flex-col items-center w-16 gap-1"><i class="fa-solid fa-power-off text-xl"></i><span class="text-[10px] font-bold">Out</span></button>
                </div>
            </template>
            <template x-if="user?.role === 'admin'">
                <div class="contents">
                    <button @click="view='admin'; loadAdminData()" class="text-primary flex flex-col items-center w-full"><i class="fa-solid fa-chart-pie text-xl"></i><span class="text-[10px] font-bold">Admin Dashboard</span></button>
                </div>
            </template>
        </nav>

    </div>
</body>
</html>
