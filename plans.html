<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upgrade - WatchJob</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#1e293b', 
                        gold: '#f59e0b', 
                        accent: '#3b82f6' 
                    }, 
                    fontFamily: { sans: ['Inter', 'sans-serif'] } 
                } 
            } 
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .modal-enter { animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col max-w-lg mx-auto shadow-2xl bg-white" x-data="plansApp()" x-init="init()">

    <!-- CUSTOM MODAL (Confirmation & Alert) -->
    <div class="fixed inset-0 z-[100] flex items-center justify-center px-4" x-show="modal.show" x-cloak>
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" 
             x-show="modal.show"
             x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100"></div>
        
        <!-- Card -->
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative z-10 text-center modal-enter"
             x-show="modal.show">
            
            <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" 
                 :class="modal.type === 'confirm' ? 'bg-blue-50 text-blue-600' : (modal.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-emerald-50 text-emerald-600')">
                <i class="fa-solid text-2xl" :class="modal.type === 'confirm' ? 'fa-question' : (modal.type === 'error' ? 'fa-circle-xmark' : 'fa-check')"></i>
            </div>
            
            <h3 class="text-xl font-bold text-slate-900 mb-2" x-text="modal.title"></h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed" x-text="modal.message"></p>
            
            <div class="flex gap-3">
                <button x-show="modal.type === 'confirm'" 
                        @click="modal.show = false" 
                        class="flex-1 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-50 transition">
                    Batal
                </button>
                <button @click="handleConfirm" 
                        class="flex-1 py-3 rounded-xl font-bold text-sm text-white shadow-lg transition"
                        :class="modal.type === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-primary hover:bg-slate-800'">
                    <span x-text="modal.type === 'confirm' ? 'Ya, Beli' : 'OK'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="fixed inset-0 z-[110] flex items-center justify-center bg-black/50 backdrop-blur-sm" x-show="isLoading" x-cloak>
        <div class="bg-white p-4 rounded-full shadow-xl">
            <i class="fa-solid fa-circle-notch fa-spin text-primary text-2xl"></i>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-16 bg-white border-b flex items-center px-6 shrink-0 z-20">
        <h1 class="font-bold text-lg text-slate-800">Upgrade Level</h1>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 overflow-y-auto p-5 pb-28 space-y-5">
        <template x-for="p in plans" :key="p.id">
            <div class="bg-white border border-slate-100 rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition relative group">
                <div class="h-32 bg-slate-800 relative overflow-hidden">
                     <img :src="p.thumbnail_url" class="absolute inset-0 w-full h-full object-cover opacity-60 transition duration-700 group-hover:scale-105" onerror="this.style.display='none'">
                     <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent"></div>
                     <div class="absolute bottom-0 left-0 p-5">
                         <p class="text-slate-300 text-[10px] font-bold uppercase tracking-wider mb-1">Membership</p>
                         <h3 class="text-white font-bold text-2xl" x-text="p.name"></h3>
                     </div>
                </div>
                <div class="p-5">
                     <div class="flex justify-between items-end mb-5">
                         <div>
                             <p class="text-xs text-slate-400 font-bold uppercase mb-1">Harga Paket</p>
                             <p class="text-2xl font-bold text-primary" x-text="fmtMoney(p.price)"></p>
                         </div>
                         <div class="text-right">
                             <span class="bg-emerald-50 text-emerald-600 text-[10px] font-bold px-2.5 py-1 rounded-lg border border-emerald-100 flex items-center gap-1">
                                 <i class="fa-regular fa-calendar"></i> <span x-text="p.duration_days + ' Hari'"></span>
                             </span>
                         </div>
                     </div>
                     
                     <div class="grid grid-cols-2 gap-3 mb-5 text-xs">
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                            <p class="text-slate-400 mb-1">Misi Harian</p>
                            <p class="font-bold text-base text-slate-800" x-text="p.daily_jobs_limit + ' Video'"></p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                            <p class="text-slate-400 mb-1">Komisi/Misi</p>
                            <p class="font-bold text-base text-emerald-600" x-text="fmtMoney(p.commission)"></p>
                        </div>
                     </div>
                     
                     <div x-show="p.return_capital" class="mb-5 p-3 bg-amber-50 rounded-xl border border-amber-100 flex items-center gap-3">
                         <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center text-amber-600"><i class="fa-solid fa-rotate-left"></i></div>
                         <div>
                             <p class="text-[10px] text-amber-800 font-bold uppercase">Jaminan Modal</p>
                             <p class="text-xs text-amber-600">Modal kembali 100% di akhir.</p>
                         </div>
                     </div>

                     <button @click="confirmBuy(p)" class="w-full py-3.5 bg-primary text-white rounded-xl font-bold text-sm hover:bg-slate-800 shadow-lg shadow-slate-200 transition transform active:scale-95">
                         Aktifkan Paket Ini
                     </button>
                </div>
            </div>
        </template>

        <div x-show="plans.length === 0 && !isLoading" class="p-10 text-center text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
            <i class="fa-solid fa-box-open text-3xl mb-3 opacity-50"></i>
            <p class="text-sm">Belum ada paket tersedia.</p>
        </div>
    </main>

    <!-- NAV -->
    <nav class="bg-white border-t flex justify-around items-center h-20 shrink-0 z-40 pb-4 text-slate-400">
        <a href="dashboard.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Beranda</span></a>
        <a href="jobs.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-play-circle text-xl"></i><span class="text-[10px] font-bold">Misi</span></a>
        <a href="plans.html" class="relative -top-6 bg-primary text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center border-4 border-slate-50"><i class="fa-solid fa-gem text-2xl"></i></a>
        <a href="wallet.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold">Dompet</span></a>
        <a href="profile.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Profil</span></a>
    </nav>

    <script>
        function plansApp() {
            return {
                plans: [],
                isLoading: false,
                modal: { show: false, title: '', message: '', type: 'info', callback: null },
                selectedPlan: null,
                userBalance: 0, // State untuk menyimpan saldo user terbaru

                init() {
                    if(!localStorage.getItem('token')) return window.location.href = 'index.html';
                    this.fetchData(); // Menggabungkan fetch plan dan fetch user
                },
                
                async fetchData() {
                    this.isLoading = true;
                    try {
                        const token = localStorage.getItem('token');
                        const user = JSON.parse(localStorage.getItem('user'));

                        // 1. Ambil data user terbaru (WAJIB untuk saldo)
                        const userRes = await fetch(`/api/users?id=${user.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const userData = await userRes.json();
                        
                        // Perbarui saldo lokal dan localStorage agar sinkron
                        this.userBalance = userData.user.balance;
                        localStorage.setItem('user', JSON.stringify(userData.user));
                        
                        // 2. Ambil daftar plans
                        const plansRes = await fetch('/api/plans', { headers: { 'Authorization': `Bearer ${token}` } });
                        this.plans = await plansRes.json();
                        
                    } catch(e) {
                        console.error(e);
                        this.showModal('error', 'Gagal Memuat Data', 'Gagal memuat saldo atau daftar paket. Silakan coba lagi.');
                    } finally {
                        this.isLoading = false;
                    }
                },

                // 1. Tampilkan Modal Konfirmasi
                confirmBuy(p) {
                    // Cek Saldo sebelum menampilkan modal konfirmasi
                    if (this.userBalance < p.price) {
                         this.showModal('error', 'Saldo Tidak Cukup', `Saldo Anda (${this.fmtMoney(this.userBalance)}) tidak mencukupi untuk membeli paket ${p.name} seharga ${this.fmtMoney(p.price)}.`);
                         return;
                    }
                    
                    this.selectedPlan = p;
                    this.modal = {
                        show: true,
                        type: 'confirm',
                        title: 'Konfirmasi Pembelian',
                        message: `Anda akan membeli paket ${p.name} seharga ${this.fmtMoney(p.price)}. Saldo akan terpotong otomatis. Lanjutkan?`,
                        callback: this.processBuy
                    };
                },

                // 2. Eksekusi Pembelian saat tombol "Ya" diklik
                async processBuy() {
                    this.modal.show = false;
                    this.isLoading = true;
                    
                    try {
                        const res = await fetch('/api/plans', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: JSON.stringify({ plan_id: this.selectedPlan.id })
                        });
                        
                        const json = await res.json();
                        
                        if(!res.ok) throw new Error(json.error);
                        
                        // Setelah sukses, tampilkan Modal Sukses dan redirect
                        this.showModal('success', 'Pembelian Berhasil!', json.message, () => {
                            window.location.href = 'dashboard.html';
                        });

                    } catch(e) {
                        this.showModal('error', 'Gagal Membeli', e.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                // Helper untuk menampilkan modal info/error/sukses
                showModal(type, title, message, callback = null) {
                    this.modal = { show: true, type, title, message, callback };
                },

                // Handler tombol di dalam modal
                handleConfirm() {
                    if (this.modal.callback) {
                        this.modal.callback.call(this); 
                    } else {
                        this.modal.show = false;
                    }
                },

                fmtMoney(n) { 
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0); 
                }
            }
        }
    </script>
</body>
</html>
