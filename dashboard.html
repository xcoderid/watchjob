<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - WatchJob</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#1e293b', gold: '#f59e0b' }, fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>[x-cloak]{display:none} .nav-item.active{color:#1e293b;}</style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col max-w-lg mx-auto shadow-2xl bg-white" x-data="dashApp()" x-init="init()">

    <!-- HEADER -->
    <header class="h-16 bg-white border-b flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <!-- AVATAR ICON PEOPLE -->
            <div class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-sm border border-slate-200">
                <i class="fa-solid fa-user"></i>
            </div>
            <div>
                <p class="text-[10px] font-bold text-slate-400 uppercase">Total Saldo</p>
                <!-- Saldo dibaca dari user state yang dijamin update dari fetchData -->
                <p class="font-bold text-base text-slate-800" x-text="fmtMoney(user?.balance || 0)"></p>
            </div>
        </div>
        <button @click="logout" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-power-off"></i></button>
    </header>

    <!-- RUNNING TEXT -->
    <div class="bg-slate-800 text-white text-xs py-2 overflow-hidden whitespace-nowrap shrink-0">
        <div class="inline-block animate-marquee px-4 font-medium" x-text="running_text"></div>
    </div>

    <!-- CONTENT -->
    <main class="flex-1 overflow-y-auto p-5 pb-28">
        <!-- HERO CARD -->
        <div class="bg-primary rounded-3xl p-6 text-white shadow-lg relative overflow-hidden mb-6">
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-slate-400 text-xs font-medium mb-1">Paket Anda</p>
                        <div class="inline-flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full border border-white/10">
                            <i class="fa-solid fa-crown text-gold text-xs"></i>
                            <span class="text-xs font-bold" x-text="planName"></span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-400 text-xs font-medium mb-1">Income Hari Ini</p>
                        <p class="text-xl font-bold text-emerald-400" x-text="fmtMoney(todayIncome)"></p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
                    <div class="text-xs text-slate-300">Tugas diselesaikan: <span class="text-white font-bold" x-text="tasksDone"></span></div>
                    <a href="plans.html" class="bg-gold text-slate-900 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-yellow-400">Upgrade</a>
                </div>
            </div>
            <div class="absolute -bottom-6 -right-6 text-8xl text-white/5"><i class="fa-solid fa-wallet"></i></div>
        </div>

        <!-- MENU GRID -->
        <div class="grid grid-cols-4 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <a href="wallet.html" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-circle-down"></i></div><span class="text-[10px] font-bold text-slate-600">Deposit</span></a>
            <a href="wallet.html?tab=wd" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-red-50 text-red-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-circle-up"></i></div><span class="text-[10px] font-bold text-slate-600">Withdraw</span></a>
            <a href="referral.html" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-users"></i></div><span class="text-[10px] font-bold text-slate-600">Tim</span></a>
            <a href="history.html" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-clock-rotate-left"></i></div><span class="text-[10px] font-bold text-slate-600">Riwayat</span></a>
            <a href="bank.html" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-building-columns"></i></div><span class="text-[10px] font-bold text-slate-600">Bank</span></a>
            <a href="password.html" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-lock"></i></div><span class="text-[10px] font-bold text-slate-600">Sandi</span></a>
            
            <!-- REVISI LINK INFO & CS -->
            <a href="cs" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-headset"></i></div><span class="text-[10px] font-bold text-slate-600">CS</span></a>
            <a href="info" class="flex flex-col items-center gap-2 group"><div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-600 flex items-center justify-center text-xl shadow-sm group-active:scale-95 transition"><i class="fa-solid fa-info-circle"></i></div><span class="text-[10px] font-bold text-slate-600">Info</span></a>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="bg-white border-t flex justify-around items-center h-20 shrink-0 z-40 pb-4 text-slate-400">
        <a href="dashboard.html" class="flex flex-col items-center w-16 gap-1 nav-item active"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Beranda</span></a>
        <a href="jobs.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-play-circle text-xl"></i><span class="text-[10px] font-bold">Misi</span></a>
        <a href="plans.html" class="relative -top-6 bg-primary text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center border-4 border-slate-50"><i class="fa-solid fa-gem text-2xl"></i></a>
        <a href="wallet.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold">Dompet</span></a>
        <a href="profile.html" class="flex flex-col items-center w-16 gap-1 nav-item"><i class="fa-solid fa-user text-xl"></i><span class="text-[10px] font-bold">Profil</span></a>
    </nav>

    <script>
        function dashApp() {
            return {
                // Inisialisasi user dari storage
                user: JSON.parse(localStorage.getItem('user') || '{}'),
                token: localStorage.getItem('token'),
                planName: 'Loading...',
                todayIncome: 0,
                tasksDone: 0,
                running_text: '',
                init() {
                    if(!this.token) return window.location.href = 'index.html';
                    this.fetchData();
                },
                async fetchData() {
                    try {
                        // Pastikan ID user tersedia
                        const userId = this.user.id;
                        if (!userId) { 
                             console.error("User ID not available in storage.");
                             this.logout();
                             return;
                        }

                        const res = await fetch(`/api/users?id=${userId}`, { headers: {'Authorization': `Bearer ${this.token}`} });
                        
                        if(!res.ok) { 
                            console.error("Failed fetching data:", res.status);
                            this.logout(); 
                            return; 
                        }
                        
                        const data = await res.json();
                        
                        this.user = data.user; 
                        
                        this.planName = data.plan?.name || 'Trial Member';
                        this.todayIncome = data.user.today_income;
                        this.tasksDone = data.user.tasks_done;
                        this.running_text = data.running_text;
                        
                        // Perbarui localStorage dengan data terbaru (termasuk balance)
                        localStorage.setItem('user', JSON.stringify(this.user));
                    } catch(e){
                         console.error("Error fetching dashboard data:", e);
                    }
                },
                fmtMoney(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0); },
                logout() { localStorage.clear(); window.location.href = 'index.html'; }
            }
        }
    </script>
</body>
</html>
