<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nonton - WatchJob</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#1e293b', 
                        gold: '#f59e0b',
                        accent: '#3b82f6'
                    }, 
                    fontFamily: { sans: ['Inter', 'sans-serif'] } 
                } 
            } 
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        /* Aspect Ratio 16:9 untuk Video */
        .aspect-video { aspect-ratio: 16 / 9; }
        
        /* Animasi Modal Sukses */
        .modal-enter { animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col max-w-lg mx-auto shadow-2xl bg-white" x-data="playerApp()" x-init="init()">

    <!-- SUCCESS MODAL (CUSTOM POPUP) -->
    <div class="fixed inset-0 z-[100] flex items-center justify-center px-4" x-show="successModal.show" x-cloak>
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" 
             x-show="successModal.show" 
             x-transition:enter="transition ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100"></div>
        
        <!-- Card Content -->
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 relative z-10 text-center modal-enter"
             x-show="successModal.show">
            
            <!-- Icon -->
            <div class="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-emerald-100">
                <i class="fa-solid fa-check text-4xl text-emerald-500"></i>
            </div>
            
            <!-- Title -->
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Komisi Diterima</h2>
            
            <!-- Amount -->
            <p class="text-sm text-slate-500 mb-6">
                Selamat! Anda telah mendapatkan komisi sebesar <br>
                <span class="text-2xl font-bold text-emerald-600 mt-2 block" x-text="fmtMoney(successModal.reward)"></span>
            </p>
            
            <!-- Button -->
            <button @click="finishClaim" class="w-full py-3.5 bg-primary text-white rounded-xl font-bold text-sm hover:bg-slate-800 transition shadow-lg shadow-slate-200">
                Kembali ke Dashboard
            </button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-16 bg-white border-b flex items-center justify-between px-6 shrink-0 z-20">
        <a href="jobs.html" class="text-slate-600 hover:text-primary w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-50 transition">
            <i class="fa-solid fa-arrow-left text-xl"></i>
        </a>
        <h1 class="font-bold text-lg text-slate-800">Nonton Video</h1>
        <div class="w-10"></div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 overflow-y-auto p-5 space-y-6">
        
        <!-- VIDEO CONTAINER -->
        <div class="bg-black rounded-2xl overflow-hidden shadow-xl relative aspect-video group bg-slate-900 border border-slate-800">
            
            <!-- 1. YouTube Iframe -->
            <div id="youtube-player" class="w-full h-full"></div>

            <!-- 2. Thumbnail Overlay -->
            <div x-show="playerState === 'unstarted' || playerState === 'cued'" 
                 class="absolute inset-0 z-20 bg-black cursor-pointer" 
                 @click="playVideo">
                <img :src="job ? 'https://img.youtube.com/vi/'+getYtId(job.youtube_url)+'/hqdefault.jpg' : ''" 
                     class="w-full h-full object-cover opacity-70 transition duration-500 group-hover:opacity-50">
                
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <div class="w-16 h-16 bg-red-600 text-white rounded-full flex items-center justify-center shadow-2xl transform transition duration-300 group-hover:scale-110 hover:bg-red-700">
                        <i class="fa-solid fa-play text-2xl ml-1"></i>
                    </div>
                    <p class="mt-3 text-white font-bold text-sm drop-shadow-md animate-pulse">Ketuk untuk Mulai</p>
                </div>
            </div>

            <!-- 3. Pause / Blur Overlay -->
            <div x-show="(playerState === 'paused' && playerState !== 'unstarted') || (!isFocused && playerState === 'playing')" 
                 class="absolute inset-0 z-30 bg-black/90 flex flex-col items-center justify-center text-white backdrop-blur-sm transition"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 style="display: none;">
                
                <i class="fa-solid fa-pause text-5xl mb-3 text-gold animate-bounce"></i>
                <p class="font-bold text-lg">Video Dijeda</p>
                <p class="text-xs text-slate-400 mt-1 text-center px-4">Jangan berpindah tab atau aplikasi.<br>Tonton sampai habis untuk klaim.</p>
                
                <button @click="playVideo" class="mt-6 px-8 py-2.5 bg-white text-primary rounded-full text-sm font-bold hover:bg-slate-200 transition shadow-lg transform active:scale-95">
                    LANJUTKAN NONTON
                </button>
            </div>
            
            <!-- 4. Loading Spinner -->
            <div x-show="isLoadingVideo" class="absolute inset-0 z-10 flex items-center justify-center bg-black text-white">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-slate-500"></i>
            </div>
        </div>

        <!-- INFO & CONTROLS -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h1 class="font-bold text-lg text-slate-900 leading-tight mb-2 line-clamp-2" x-text="job?.title || 'Memuat Data...'"></h1>
            <p class="text-xs text-slate-500 mb-5 border-b border-slate-100 pb-4">Selesaikan durasi tonton untuk mendapatkan komisi ke saldo utama Anda.</p>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1.5 opacity-10"><i class="fa-solid fa-coins text-4xl text-emerald-600"></i></div>
                    <p class="text-[10px] text-emerald-600 uppercase font-bold mb-1 tracking-wider">Komisi Anda</p>
                    <p class="text-emerald-700 font-bold text-xl" x-text="fmtMoney(commission)"></p>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1.5 opacity-10"><i class="fa-solid fa-clock text-4xl text-slate-600"></i></div>
                    <p class="text-[10px] text-slate-500 uppercase font-bold mb-1 tracking-wider">Sisa Waktu</p>
                    <p class="font-bold text-xl" :class="timer > 0 ? 'text-amber-600' : 'text-primary'" x-text="timer > 0 ? timer + ' Detik' : 'Selesai'"></p>
                    <div class="absolute bottom-0 left-0 h-1.5 bg-slate-200 w-full">
                        <div class="h-full bg-amber-500 transition-all duration-1000 ease-linear" :style="`width: ${((initialTimer - timer) / initialTimer) * 100}%`"></div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col gap-3">
                <!-- Tombol Klaim -->
                <button 
                    x-show="timer <= 0"
                    @click="claim" 
                    :disabled="isClaiming"
                    class="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold text-base shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition transform active:scale-95 flex justify-center items-center gap-2 animate-pulse">
                    <i x-show="!isClaiming" class="fa-solid fa-gift"></i>
                    <span x-text="isClaiming ? 'Memproses...' : 'KLAIM KOMISI SEKARANG'"></span>
                </button>

                <!-- Status Button -->
                <button 
                    x-show="timer > 0"
                    disabled
                    class="w-full py-4 bg-slate-100 text-slate-400 rounded-xl font-bold text-sm cursor-not-allowed border border-slate-200 flex items-center justify-center gap-2">
                    <i x-show="playerState === 'playing'" class="fa-solid fa-circle-notch fa-spin text-xs"></i>
                    <span x-text="playerState === 'playing' ? 'Sedang Menonton...' : 'Video Belum Selesai'"></span>
                </button>
                
                <a href="jobs.html" class="w-full py-3.5 border border-slate-200 text-slate-500 rounded-xl font-bold text-sm hover:bg-slate-50 hover:text-slate-700 text-center transition mt-2">Kembali ke Daftar Misi</a>
            </div>
        </div>

    </main>

    <script>
        var onYouTubeIframeAPIReady;

        function playerApp() {
            return {
                job: null,
                commission: 0,
                timer: 0,
                initialTimer: 0,
                player: null,
                playerState: 'unstarted', 
                isFocused: true,
                interval: null,
                isClaiming: false,
                isLoadingVideo: true,
                successModal: { show: false, reward: 0 }, // Modal state
                
                async init() {
                    if(!localStorage.getItem('token')) {
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const id = urlParams.get('id');
                    
                    if(!id) {
                        window.location.href = 'jobs.html';
                        return;
                    }

                    document.addEventListener("visibilitychange", () => { 
                        this.isFocused = !document.hidden;
                        if (!this.isFocused && this.player && typeof this.player.pauseVideo === 'function' && this.playerState === 'playing') {
                            this.player.pauseVideo();
                        }
                    });

                    await this.fetchJobData(id);
                    this.loadYoutubeAPI();
                },

                async fetchJobData(id) {
                    try {
                        const res = await fetch('/api/jobs', { 
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } 
                        });
                        
                        if(res.status === 401) {
                            localStorage.clear();
                            window.location.href = 'index.html';
                            return;
                        }

                        const data = await res.json();
                        this.job = data.jobs ? data.jobs.find(j => j.id == id) : null;
                        
                        if(!this.job) {
                            alert('Job tidak ditemukan.');
                            window.location.href = 'jobs.html';
                            return;
                        }

                        this.commission = data.user_commission;
                        this.timer = this.job.duration;
                        this.initialTimer = this.job.duration;

                    } catch(e) { 
                        console.error(e);
                        alert('Gagal memuat data job.');
                        window.location.href = 'jobs.html';
                    }
                },

                loadYoutubeAPI() {
                    if (!window.YT) {
                        const tag = document.createElement('script');
                        tag.src = "https://www.youtube.com/iframe_api";
                        const firstScriptTag = document.getElementsByTagName('script')[0];
                        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                    }
                    window.onYouTubeIframeAPIReady = () => { this.initPlayer(); };
                    if (window.YT && window.YT.Player) { this.initPlayer(); }
                },

                initPlayer() {
                    if (!this.job) return;
                    const videoId = this.getYtId(this.job.youtube_url);
                    if (this.player) { try { this.player.destroy(); } catch(e){} this.player = null; }

                    this.player = new YT.Player('youtube-player', {
                        height: '100%',
                        width: '100%',
                        videoId: videoId,
                        playerVars: {
                            'playsinline': 1, 'controls': 0, 'rel': 0, 'fs': 0, 'disablekb': 1, 'modestbranding': 1, 'origin': window.location.origin
                        },
                        events: {
                            'onReady': () => { this.isLoadingVideo = false; this.playerState = 'cued'; },
                            'onStateChange': (e) => this.onPlayerStateChange(e)
                        }
                    });
                },

                onPlayerStateChange(event) {
                    if (event.data === YT.PlayerState.PLAYING) {
                        this.playerState = 'playing';
                        this.startTimer();
                    } 
                    else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
                        this.playerState = 'paused';
                        this.stopTimer();
                    } 
                    else if (event.data === YT.PlayerState.ENDED) {
                        this.playerState = 'ended';
                        this.stopTimer();
                    }
                },

                playVideo() {
                    if (this.player && typeof this.player.playVideo === 'function') {
                        this.player.playVideo();
                    }
                },

                startTimer() {
                    this.stopTimer();
                    this.interval = setInterval(() => {
                        if (this.isFocused && this.timer > 0) {
                            this.timer--;
                        }
                        if (this.timer <= 0) {
                            this.stopTimer();
                        }
                    }, 1000);
                },

                stopTimer() {
                    if (this.interval) {
                        clearInterval(this.interval);
                        this.interval = null;
                    }
                },

                async claim() {
                    if(this.timer > 0) return;
                    this.isClaiming = true;
                    try {
                        const res = await fetch('/api/jobs', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: JSON.stringify({ action: 'claim', job_id: this.job.id })
                        });
                        
                        const json = await res.json();
                        if(!res.ok) throw new Error(json.error || 'Gagal klaim komisi');
                        
                        // Tampilkan Custom Modal
                        this.successModal.reward = json.reward;
                        this.successModal.show = true;
                        
                    } catch(e) { 
                        alert(e.message); 
                    } finally { 
                        this.isClaiming = false; 
                    }
                },

                finishClaim() {
                    window.location.href = 'dashboard.html';
                },

                getYtId(url) { 
                    if (!url) return null;
                    const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); 
                    return (m && m[2].length === 11) ? m[2] : null; 
                },
                
                fmtMoney(n) { 
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0); 
                }
            }
        }
    </script>
</body>
</html>
