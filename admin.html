<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - WatchJob</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#0f172a', emerald: { 500: '#10b981', 600: '#059669' } } } }
        }
    </script>
    <script>
        function adminApp() {
            return {
                token: localStorage.getItem('token'),
                user: JSON.parse(localStorage.getItem('user') || 'null'),
                view: 'dashboard',
                toast: { show: false, msg: '' },
                
                // Data Containers
                stats: { users:0, deposit:0, pending_wd:0, pending_depo:0 },
                pendingTx: [],
                users: [],
                plans: [],
                settings: { running_text: '', l1:0, l2:0, l3:0 },
                forms: { job: { title: '', url: '', min_plan: 1 }, plan: { name: '', price: '', duration: 30, daily_jobs: 5, commission: 100, thumbnail: '' } },

                async init() {
                    if (!this.token || this.user?.role !== 'admin') return window.location.href = 'index.html';
                    await this.loadData();
                },

                async api(url, method = 'GET', body = null) {
                    try {
                        const res = await fetch(`/api${url}`, {
                            method, 
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.token}` },
                            body: body ? JSON.stringify(body) : null
                        });
                        if (res.status === 401 || res.status === 403) {
                            localStorage.clear();
                            window.location.href = 'index.html';
                            return;
                        }
                        const json = await res.json();
                        if(!res.ok) throw new Error(json.error);
                        return json;
                    } catch (e) {
                        this.showToast(e.message, 'error');
                        throw e;
                    }
                },

                async loadData() {
                    try {
                        const [s, pTx, u, pl, set] = await Promise.all([
                            this.api('/admin?type=stats'),
                            this.api('/admin?type=pending_tx'),
                            this.api('/admin?type=users'),
                            this.api('/admin?type=plans'),
                            this.api('/admin?type=settings')
                        ]);
                        this.stats = s;
                        this.pendingTx = pTx;
                        this.users = u;
                        this.plans = pl;
                        if(set.l1) this.settings = set;
                    } catch(e){}
                },

                async processTx(id, decision) {
                    if(!confirm('Konfirmasi tindakan?')) return;
                    try {
                        await this.api('/admin', 'POST', { action: 'process_tx', tx_id: id, decision });
                        this.showToast('Transaksi diproses');
                        this.loadData();
                    } catch(e){}
                },

                async createJob() {
                    try {
                        await this.api('/admin', 'POST', { action: 'create_job', ...this.forms.job });
                        this.showToast('Job ditambahkan');
                        this.forms.job.title = '';
                    } catch(e){}
                },

                async createPlan() {
                    try {
                        await this.api('/admin', 'POST', { action: 'create_plan', ...this.forms.plan });
                        this.showToast('Plan dibuat');
                        this.loadData();
                    } catch(e){}
                },

                async saveSettings() {
                    try {
                        await this.api('/admin', 'POST', { action: 'update_settings', ...this.settings });
                        this.showToast('Disimpan');
                    } catch(e){}
                },

                async toggleUser(uid, type) {
                    try {
                        await this.api('/admin', 'POST', { action: 'user_action', user_id: uid, type });
                        this.loadData();
                    } catch(e){}
                },

                fmtMoney(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0); },
                showToast(msg) { this.toast = { show: true, msg }; setTimeout(() => this.toast.show = false, 3000); }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col overflow-hidden" x-data="adminApp()" x-init="init()">

    <div class="fixed top-5 right-5 z-50 bg-slate-800 text-white px-4 py-2 rounded shadow-lg text-sm font-bold" x-show="toast.show" x-transition x-cloak x-text="toast.msg"></div>

    <header class="bg-slate-900 text-white h-16 flex items-center justify-between px-6 shrink-0 shadow z-20">
        <h1 class="font-bold text-lg tracking-wide">Admin Console</h1>
        <button @click="localStorage.clear(); location.href='index.html'" class="bg-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-700">LOGOUT</button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-white border-r flex flex-col">
            <nav class="p-4 space-y-1">
                <button @click="view='dashboard'" :class="view==='dashboard'?'bg-slate-100 text-emerald-600 border-r-4 border-emerald-500':'text-slate-600 hover:bg-slate-50'" class="w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3 transition-all"><i class="fa-solid fa-gauge w-5"></i> Dashboard</button>
                <button @click="view='approvals'" :class="view==='approvals'?'bg-slate-100 text-emerald-600 border-r-4 border-emerald-500':'text-slate-600 hover:bg-slate-50'" class="w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3 transition-all"><i class="fa-solid fa-list-check w-5"></i> Approvals <span x-show="(stats.pending_wd+stats.pending_depo)>0" class="ml-auto bg-red-500 text-white text-[10px] px-2 rounded-full" x-text="stats.pending_wd+stats.pending_depo"></span></button>
                <button @click="view='users'" :class="view==='users'?'bg-slate-100 text-emerald-600 border-r-4 border-emerald-500':'text-slate-600 hover:bg-slate-50'" class="w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3 transition-all"><i class="fa-solid fa-users w-5"></i> Users</button>
                <button @click="view='content'" :class="view==='content'?'bg-slate-100 text-emerald-600 border-r-4 border-emerald-500':'text-slate-600 hover:bg-slate-50'" class="w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3 transition-all"><i class="fa-solid fa-box w-5"></i> Content</button>
                <button @click="view='settings'" :class="view==='settings'?'bg-slate-100 text-emerald-600 border-r-4 border-emerald-500':'text-slate-600 hover:bg-slate-50'" class="w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3 transition-all"><i class="fa-solid fa-gear w-5"></i> Settings</button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-8">
            <!-- DASHBOARD -->
            <div x-show="view==='dashboard'" class="grid grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500"><p class="text-xs text-slate-400 font-bold uppercase">Deposit Sukses</p><h3 class="text-2xl font-bold mt-1" x-text="fmtMoney(stats.deposit)"></h3></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500"><p class="text-xs text-slate-400 font-bold uppercase">Total User</p><h3 class="text-2xl font-bold mt-1" x-text="stats.users"></h3></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-amber-500"><p class="text-xs text-slate-400 font-bold uppercase">Pending Depo</p><h3 class="text-2xl font-bold mt-1 text-amber-600" x-text="fmtMoney(stats.pending_depo)"></h3></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500"><p class="text-xs text-slate-400 font-bold uppercase">Pending WD</p><h3 class="text-2xl font-bold mt-1 text-red-600" x-text="fmtMoney(stats.pending_wd)"></h3></div>
            </div>

            <!-- APPROVALS -->
            <div x-show="view==='approvals'" class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold"><tr><th class="p-4">Tipe</th><th class="p-4">User</th><th class="p-4">Jumlah</th><th class="p-4">Ket</th><th class="p-4 text-right">Aksi</th></tr></thead>
                    <tbody class="divide-y">
                        <template x-for="tx in pendingTx" :key="tx.id">
                            <tr>
                                <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold uppercase" :class="tx.type==='deposit'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'" x-text="tx.type"></span></td>
                                <td class="p-4 font-bold" x-text="tx.username"></td>
                                <td class="p-4 font-mono" x-text="fmtMoney(tx.amount)"></td>
                                <td class="p-4 text-xs text-slate-500" x-text="tx.description"></td>
                                <td class="p-4 text-right space-x-2"><button @click="processTx(tx.id, 'approve')" class="bg-emerald-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-emerald-600">ACC</button><button @click="processTx(tx.id, 'reject')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600">TOLAK</button></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- USERS -->
            <div x-show="view==='users'" class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold"><tr><th class="p-4">User</th><th class="p-4">Email</th><th class="p-4">Saldo</th><th class="p-4">Status</th><th class="p-4 text-right">Aksi</th></tr></thead>
                    <tbody class="divide-y">
                        <template x-for="u in users" :key="u.id">
                            <tr>
                                <td class="p-4 font-bold" x-text="u.username"></td>
                                <td class="p-4" x-text="u.email"></td>
                                <td class="p-4 font-mono" x-text="fmtMoney(u.balance)"></td>
                                <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold uppercase" :class="u.status==='active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'" x-text="u.status"></span></td>
                                <td class="p-4 text-right"><button @click="toggleUser(u.id, u.status==='active'?'ban':'unban')" class="border px-2 py-1 rounded text-xs font-bold hover:bg-slate-100" x-text="u.status==='active'?'BAN':'UNBAN'"></button></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- CONTENT -->
            <div x-show="view==='content'" class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-bold mb-4">Tambah Job</h3>
                    <div class="grid grid-cols-3 gap-4 items-end">
                        <div><label class="text-xs font-bold text-slate-500">Link Youtube</label><input x-model="forms.job.url" class="w-full p-2 border rounded text-sm mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-500">Judul</label><input x-model="forms.job.title" class="w-full p-2 border rounded text-sm mt-1"></div>
                        <button @click="createJob" class="bg-slate-800 text-white h-[38px] rounded text-sm font-bold">Simpan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border">
                    <h3 class="font-bold mb-4">Buat Plan</h3>
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <input x-model="forms.plan.name" class="p-2 border rounded text-sm" placeholder="Nama Plan">
                        <input x-model="forms.plan.price" type="number" class="p-2 border rounded text-sm" placeholder="Harga">
                        <input x-model="forms.plan.commission" type="number" class="p-2 border rounded text-sm" placeholder="Komisi/Job">
                        <input x-model="forms.plan.daily_jobs" type="number" class="p-2 border rounded text-sm" placeholder="Limit Job">
                    </div>
                    <div class="flex justify-end"><button @click="createPlan" class="bg-emerald-600 text-white px-6 py-2 rounded text-sm font-bold">Buat Plan</button></div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div x-show="view==='settings'" class="bg-white p-6 rounded-xl shadow-sm border max-w-2xl">
                <h3 class="font-bold mb-4">Global Config</h3>
                <div class="space-y-4">
                    <div><label class="text-sm font-bold">Running Text</label><textarea x-model="settings.running_text" class="w-full p-2 border rounded mt-1"></textarea></div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-xs font-bold">Komisi L1 (%)</label><input x-model="settings.l1" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="text-xs font-bold">Komisi L2 (%)</label><input x-model="settings.l2" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="text-xs font-bold">Komisi L3 (%)</label><input x-model="settings.l3" class="w-full p-2 border rounded mt-1"></div>
                    </div>
                    <button @click="saveSettings" class="bg-slate-800 text-white px-6 py-2 rounded text-sm font-bold">Simpan Config</button>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
